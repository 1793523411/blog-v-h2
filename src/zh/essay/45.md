---
time: 2021-04-09
icon: template
category: é¢è¯•
article: true
sidebar: auto
footer: ğŸ˜ğŸ˜ğŸ˜
tag:
  - å‰ç«¯
  - nodejs
---

# expresæ€»ç»“

## express3.x æ ¸å¿ƒ

express3.x ä¸ express4.x çš„åŒºåˆ«ï¼šexpress4.x è‡ªå·±å®ç°äº† connect ç»„ä»¶ï¼Œå¢åŠ äº† proxy ç­‰

### concat ä½œç”¨

concat ä¸»è¦é€»è¾‘

```js
function createServer() {
  // appæ˜¯ç”¨äºhttp.createServerçš„å›è°ƒå‡½æ•°
  function app(req, res, next) {
    // è¿è¡Œæ—¶è°ƒç”¨handleå‡½æ•°
    app.handle(req, res, next);
  }

  mixin(app, proto, false);

  // åˆå§‹åŒ–ä¸€ä¸ªstackæ•°ç»„
  app.stack = [];
  return app;
}

// useè°ƒç”¨æ—¶å¾€appçš„stackæ•°ç»„ä¸­pushä¸€ä¸ªå¯¹è±¡ï¼ˆä¸­é—´ä»¶ï¼‰ï¼Œæ ‡è¯†pathä¸å›è°ƒå‡½æ•°
proto.use = function (route, fn) {
  var path = route,
    handle = fn;

  //...  çœç•¥å…¶ä»–

  this.stack.push({
    route: path,
    handle,
  });
};

// handleæ–¹æ³•ï¼Œä¸²è¡Œå–å‡ºstackæ•°ç»„ä¸­çš„ä¸­é—´ä»¶ï¼Œé€ä¸ªè¿è¡Œ
proto.handle = function (req, res, out) {
  var index = 0;
  var stack = this.stack;
  var done = out || finalhandler(req, res, { onerror: logerror });

  // éå†stackï¼Œé€ä¸ªå–å‡ºä¸­é—´ä»¶è¿è¡Œ
  function next(err) {
    var layer = stack[index++];
    // éå†å®Œæˆä¸ºæ­¢
    if (layer === undefined) {
      return done();
    }

    var route = pathFormat(layer.route);
    var pathname = pathFormat(urlParser(req.url).pathname || "/");

    // åŒ¹é…ä¸­é—´ä»¶ï¼Œä¸åŒ¹é…çš„ä¸è¿è¡Œ
    if (route !== "" && pathname !== route) {
      next(err);
      return;
    }

    // è°ƒç”¨ä¸­é—´ä»¶
    call(layer.handle, err, req, res, next);
  }

  next();
};
next();
```

app.use ä¸­é—´ä»¶æ—¶ï¼Œåªæ˜¯æŠŠå®ƒæ”¾å…¥ä¸€ä¸ªæ•°ç»„ä¸­ã€‚å½“ http è¯·æ±‚æ—¶ï¼Œapp ä¼šä»æ•°ç»„ä¸­é€ä¸ªå–å‡ºï¼Œè¿›è¡ŒåŒ¹é…è¿‡æ»¤ï¼Œé€ä¸ªè¿è¡Œã€‚éå†å®Œæˆåï¼Œè¿è¡Œ finalhandlerï¼Œç»“æŸä¸€ä¸ª http è¯·æ±‚ã€‚å¯ä»¥ä» http è¯·æ±‚çš„è§’åº¦æ€è€ƒï¼Œä¸€æ¬¡è¯·æ±‚å®ƒç»å†ç»å†äº†å¤šå°‘ä¸œè¥¿ã€‚express çš„è¿™ä¸ªä¸­é—´ä»¶æ¶æ„å°±æ˜¯è´Ÿè´£ç®¡ç†ä¸è°ƒç”¨è¿™äº›æ³¨å†Œçš„ä¸­é—´ä»¶ã€‚ä¸­é—´ä»¶é¡ºåºæ‰§è¡Œï¼Œé€šè¿‡ next æ¥ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œä¸€æ—¦æ²¡æœ‰ç»§ç»­ nextï¼Œåˆ™æµç¨‹ç»“æŸ

ä¸Šé¢çš„å†…å®¹å«åšå¼‚æ­¥ä¸²è¡Œæµç¨‹æ§åˆ¶

ä¸€ä¸ªç®€å•çš„å®ç°

ä¸ºäº†ç”¨ä¸²è¡ŒåŒ–æµç¨‹æ§åˆ¶è®©å‡ ä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œéœ€è¦å…ˆæŠŠè¿™äº›ä»»åŠ¡æŒ‰é¢„æœŸçš„æ‰§è¡Œé¡ºåºæ”¾ åˆ°ä¸€ä¸ªæ•°ç»„ä¸­,æ•°ç»„ä¸­çš„æ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚ä»»åŠ¡å®Œæˆååº”è¯¥è°ƒç”¨ä¸€ä¸ªå¤„ç†å™¨å‡½æ•°ï¼Œå‘Šè¯‰å®ƒé”™è¯¯çŠ¶æ€å’Œ ç»“æœã€‚å¦‚æœæœ‰é”™è¯¯ï¼Œå¤„ç†å™¨å‡½æ•°ä¼šç»ˆæ­¢æ‰§è¡Œ;å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œå¤„ç†å™¨å°±ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡ æ‰§è¡Œå®ƒ

```js
// æ•°ç»„
var tasks = [
  function A() {
    //...
    next();
  },
  function B() {
    //...
    next();
  },
  function C() {
    //...
    next();
  },
  //...
];

function next(err, result) {
  if (err) throw err;
  var currentTask = tasks.shift();
  if (currentTask) currentTask(result);
  next();
}

// é¦–æ¬¡ä¸»åŠ¨è°ƒç”¨
```

å¼‚æ­¥ä¸²è¡Œæ§åˆ¶æ–¹æ¡ˆé™¤äº†ä¸Šé¢çš„è¿™ç§ä»¥å¤–ï¼Œè¿˜å¯ä»¥ç”¨ es6 çš„ promise çš„ then é“¾ã€async/awaitã€yeildã€ç¤¾åŒºå·¥å…·ç­‰

å¯ä»¥çœ‹åˆ°ä»£ç ç¡®å®è°ˆä¸ä¸Šé«˜çº§ ï¼Œä¸²è¡Œå¯¼è‡´çš„æ€§èƒ½è°ˆä¸ä¸Šä¼˜ç§€ï¼Œä½†æ˜¯å¾—ç›Šäºæ­¤å®ƒè¶³å¤Ÿç®€å•æ˜“ç”¨ã€‚åˆ°æ­¤å¯ä»¥å‘ç° express çš„ä¸­é—´ä»¶æ¶æ„å°±æ˜¯ä¸€ä¸ªä¸­é—´ä»¶çš„çš„ç®¡ç†ä¸æ•°ç»„éå†è¿è¡Œï¼Œè¿™ä¸ªæ–¹æ¡ˆå°±è®©ç¤¾åŒºå½¢å½¢è‰²è‰²å„ç§å„æ ·çš„ä¸­é—´ä»¶å¾ˆå¥½çš„æ·»åŠ  express èƒ½åŠ›ï¼Œè¿™ç‚¹å¾ˆç®€å•ä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºåç»­çš„è·¯ç”±ã€é™æ€æ–‡ä»¶æœåŠ¡ã€ä»£ç†ç­‰éƒ½æ˜¯ä¸­é—´ä»¶ï¼Œéƒ½åœ¨è¿™ä¸ªæ¡†æ¶å†…è¿è¡Œã€‚

::: tip app.use ä¸ºä»€ä¹ˆå¯ä»¥æ·»åŠ ä¸€ä¸ªåˆä¸€ä¸ªä¸­é—´ä»¶
connect ç»´æŠ¤äº†ä¸€ä¸ªä¸­é—´ä»¶æ ˆ(middleware stack)

æ•°æ®ç»“æ„ï¼šæ ˆï¼ˆstackï¼‰

æ¯æ¬¡è°ƒç”¨ useï¼Œéƒ½ä¼šå‘è¿™ä¸ªåº”ç”¨(app)å®ä¾‹çš„æ ˆ(stack)æ¨å…¥ä¸€ä¸ªå¸¦è·¯å¾„å’Œå¤„ç†å‡½æ•°çš„å¯¹è±¡

```js
function createServer() {
  function app(req, res, next) {
    app.handle(req, res, next);
  }
  // ...
  app.stack = []; // æ³¨æ„è¿™é‡Œ
  return app;
}
proto.use = function use(route, fn) {
  var handle = fn;
  var path = route;
  // ...
  // add the middleware
  this.stack.push({ route: path, handle: handle });

  return this;
};
```

:::

::: tip connect æ˜¯å¦‚ä½•åŒºåˆ†æ™®é€šä¸­é—´ä»¶å’Œé”™è¯¯ä¸­é—´ä»¶çš„ï¼Ÿ
JavaScript çš„å‡½æ•°çš„é•¿åº¦å±æ€§ï¼šlength

connect æ­£æ˜¯é€šè¿‡ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„å½¢å‚é•¿åº¦æ¥åŒºåˆ†å‡ºæ™®é€šä¸­é—´ä»¶å’Œé”™è¯¯ä¸­é—´ä»¶çš„

```js
function call(handle, route, err, req, res, next) {
  var arity = handle.length;
  var error = err;
  var hasError = Boolean(err);

  try {
    if (hasError && arity === 4) {
      // error-handling middleware
      handle(err, req, res, next);
      return;
    } else if (!hasError && arity < 4) {
      // request-handling middleware
      handle(req, res, next);
      return;
    }
  } catch (e) {
    // replace the error
    error = e;
  }

  // continue
  next(error);
}
```

çœ‹äº†æºç ï¼Œå®˜æ–¹æ–‡æ¡£å¯¹é”™è¯¯å¤„ç†ä¸­é—´ä»¶æè¿° skipping any error middleware above that middleware and any non-error middleware below çš„è§£é‡Šå…¶å®ä¹Ÿæ‡‚äº†ï¼š

- è·³è¿‡å‰é¢çš„æ‰€æœ‰é”™è¯¯ä¸­é—´ä»¶ï¼šindex å€¼æ˜¯é€’å¢çš„ï¼Œè¯·æ±‚åªèµ°åé¢çš„é”™è¯¯ä¸­é—´ä»¶
- è·³è¿‡åé¢çš„éå¼‚å¸¸å¤„ç†ä¸­é—´ä»¶ï¼šå¼‚å¸¸ä¸­é—´ä»¶ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³è¯·æ±‚ä¼šè¿›å…¥ï¼Œéå¼‚å¸¸ä¸­é—´ä»¶ç”±äº hasError ä¸º true å› æ­¤è¯·æ±‚ä¸ä¼šè¿›å…¥

åªèƒ½æœ‰ä¸€ä¸ªå¼‚å¸¸å¤„ç†ä¸­é—´ä»¶å—ï¼Ÿ å¯ä»¥æœ‰å¤šä¸ª

:::

::: tip ä¸­é—´ä»¶å¤„ç†å‡½æ•°ä¸­çš„ next æŒ‡ä»£çš„åˆæ˜¯ä»€ä¹ˆï¼Ÿ
æŒ‡ä»£çš„æ˜¯æ ˆä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶

```js
proto.handle = function handle(req, res, out) {
  var index = 0;
  var stack = this.stack;
  // ...
  function next(err) {
    // next callback
    var layer = stack[index++];

    // call the layer handle
    call(layer.handle, route, err, req, res, next);
  }

  next();
};
```

æ¯æ¬¡è°ƒç”¨ next()å‡½æ•°ï¼Œä¼šæ‰§è¡Œ index++ï¼Œlayer ä¸º middleware stack ä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚
:::

### `router`çš„ä½œç”¨

Router æ˜¯ä¸€ä¸ªå†…ç½®åœ¨ app å‡½æ•°ä¸Šçš„ä¸­é—´ä»¶

ç®€åŒ–åçš„ router

```js
//expressåˆ›å»ºæ—¶è¿è¡Œ
app.init = function () {
  // ... çœç•¥å…¶å®ƒä»£ç 
  this._router = new Router();
  this.usedRouter = false;

  // appè°ƒç”¨routeræ—¶åˆå§‹åŒ–routerä¸­é—´ä»¶
  Object.defineProperty(this, "router", {
    configurable: true,
    enumerable: true,
    get: function () {
      this.usedRouter = true;
      return this._router.middlewareInit.bind(this._router);
    },
  });
};

// methodsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ['get','post','put','delete',...]
methods.forEach((method) => {
  app[method] = function (path) {
    // å¦‚æœé¦–æ¬¡è°ƒç”¨åˆ™æ”¾å…¥è·¯ç”±ä¸­é—´ä»·
    if (!this.usedRouter) {
      this.use(this.router);
    }

    // åŠ å…¥stack
    this._router.addRoute(
      method,
      path,
      Array.prototype.slice.call(arguments, 1)
    );
  };
});
```

usedRouter æ˜¯ä¸ªå¼€å…³ï¼Œæœªå¼€å¯åˆ™ä¸åŠ å…¥ router ä¸­é—´ä»¶ï¼Œå› ä¸ºåº”ç”¨ç†è®ºä¸Šä¹Ÿæ˜¯å¯èƒ½ä¸ç”¨åˆ° router çš„ã€‚å½“`app[method]` å¦‚`app.get('/user', fn)`è°ƒç”¨åï¼Œåˆ™è§¦å‘ this.use(this.router) ä½¿ç”¨ router ä¸­é—´ä»¶ï¼ŒåŒæ—¶æŠŠ usedRouter è®¾ç½®ä¸º trueã€‚ä¹‹åå¾€ router å¯¹è±¡ä¸­åŠ å…¥ fn å›è°ƒå‡½æ•°

router å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥ä¸²è¡Œæµç¨‹æ§åˆ¶,connect éå¸¸ç±»ä¼¼,æŸä¸ª router è¿˜æ˜¯å¯ä»¥ç»§ç»­åšç±»ä¼¼çš„ä¸²è¡Œæµç¨‹æ§åˆ¶ï¼›ä¸ä¸­é—´ä»¶ç›¸åŒï¼Œæ¯ä¸ª router ä¸€æ—¦åœæ­¢äº† nextï¼Œæµç¨‹å°±ç»“æŸäº†

```js
Router.prototype.addRoute = function (method, path, handles) {
  let layer = {
    path,
    handles,
  };
  this.map[method] = this.map[method] || [];
  this.map[method].push(layer);
};

Router.prototype.middlewareInit = function (req, res, out) {
  let index = 0;
  let method = req.method.toLowerCase() || "get";
  let stack = this.map[method];

  function next(err) {
    let layer = stack[index++];
    let hasError = Boolean(err);

    // å¦‚æœæ²¡æœ‰äº†åˆ™ç»“æŸä¸­é—´ä»¶ï¼Œèµ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    if (!layer) {
      return hasError ? out(err) : out();
    }

    let route = utils.pathFormat(layer.path);
    let pathname = utils.pathFormat(urlParser(req.url).pathname || "/");

    // è¿›è¡Œè¿‡æ»¤
    if (route !== "" && route !== pathname) {
      return next(err);
    }

    executeHandles(layer.handles, err, req, res, next);
  }

  next();
};
```

### æ¨¡æ¿å¼•æ“

æ¨¡æ¿å¼•æ“ä¸æ˜¯ express å®ç°çš„ï¼Œå®é™…ä¸Š express ä»…ä»…åªæ˜¯åšäº†è°ƒç”¨ï¼›è¿™é‡Œæœ‰ä¸ªé€šç”¨çš„æ”¯æŒå„ç§æ¨¡æ¿å¼•æ“çš„æ¨¡å—`consolidate.js`,express è¦åšçš„åªæ˜¯é…ç½®ä¸è°ƒç”¨

```js
// expressè®¾ç½®å±æ€§
app.set = function (key, value) {
  if (this.settings.hasOwnProperty(key)) {
    return this.settings[key];
  }
  this.settings[key] = value;
};

app.engine = function (engine) {
  this.settings["engine"] = engine;
};
```

é€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°è®¾ç½® views è§†å›¾æ‰€åœ¨çš„è·¯å¾„ã€æ¨¡æ¿å¼•æ“ç±»å‹ï¼Œä¹‹å express å°±å¯ä»¥ç»“åˆ router æä¾›çš„ render pageï¼Œdataï¼Œrender callback çš„æ•°æ®è¿›è¡Œè§†å›¾æ¸²æŸ“,ä¸ºäº†æ€§èƒ½è€ƒè™‘è¿˜åšäº† cache

```js
app.render = function (name, options, fn) {
  let cacheTemplate = this.cache[name];

  let view =
    cacheTemplate ||
    new View(name, {
      root: process.cwd(),
      viewPath: this.settings["views"],
      engine: this.settings["engine"],
    });

  if (!cacheTemplate && this.settings["view cache"]) {
    this.cache[name] = view;
  }

  view.render(options, fn);
};
// View.js ç®€åŒ–

function View(page, config) {
  console.log("view åˆå§‹åŒ–");
  this.engine = config.engine || "ejs";
  this.templatePath = path.join(config.root, config.viewPath, page);
  this.lookup();
}

//æ£€æµ‹æ¨¡æ¿æ˜¯å¦å­˜åœ¨
View.prototype.lookup = function () {
  if (!fs.existsSync(this.templatePath)) {
    console.log("æ¨¡æ¿æ²¡æœ‰æ‰¾åˆ°");
    throw new Error("æ¨¡æ¿æ²¡æœ‰æ‰¾åˆ°");
  }
};

View.prototype.render = function (options, fn) {
  let templatePath = this.templatePath;
  // è°ƒç”¨æ¨¡æ¿å¼•æ“å®Œæˆæ¸²æŸ“
  return cons[this.engine](templatePath, options, fn);
};
```

### é™æ€æ–‡ä»¶æœåŠ¡

é™æ€æ–‡ä»¶æœåŠ¡ä¹Ÿæ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œexpress åšçš„äº‹æƒ…ä¹Ÿä»…ä»…æ˜¯å¼•ç”¨ã€‚require ä¸€ä¸ª serve-staticï¼Œå†…ç½®åœ¨ app å‡½æ•°ä¸Š

```js
//express/lib/express.js
exports.static = require("serve-static");
```

æˆ–è€…å¯ä»¥è¿™ä¹ˆç†è§£

```js
app.static = function (dir) {
  this.use(serveStatic(process.cwd() + "/" + dir), {});
};
```

express æ ¸å¿ƒä¸»è¦æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ä¸²è¡Œæ§åˆ¶æ–¹æ¡ˆï¼Œå†…ç½®æ¥ routerã€é™æ€æ–‡ä»¶æœåŠ¡ä¸­é—´ä»¶ã€æ‰©å±•äº† reqï¼Œresï¼Œå…¶ä»–åŠŸèƒ½éƒ½æ˜¯é›†æˆäº†å…¶ä»–æ¨¡å—æ¥åŠ å¼ºçš„ï¼›ç¡®å®æ˜¯ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ web æ¡†æ¶

## express4.x

### app.use å’Œ app.get

> app[method](path, function(req, res){})
>
> app.use([path,] function [, function...])
>
> app.use ä¸­æ”¾å…¥çš„å‡½æ•°ç§°ä¸ºä¸­é—´ä»¶å‡½æ•°ï¼Œä¸€èˆ¬æœ‰ä¸‰ä¸ªç‰¹ç‚¹ï¼š

> 1.  ä¸€ä¸ªä¸­é—´ä»¶å¤„ç†å®Œè¯·æ±‚å’Œå“åº”å¯ä»¥æŠŠç›¸åº”æ•°æ®å†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚
> 2.  å›è°ƒå‡½æ•°çš„ next å‚æ•°,è¡¨ç¤ºæ¥å—å…¶ä»–ä¸­é—´ä»¶çš„è°ƒç”¨ï¼Œå‡½æ•°ä½“ä¸­çš„ next(),è¡¨ç¤ºå°†è¯·æ±‚æ•°æ®ç»§ç»­ä¼ é€’ã€‚
> 3.  å¯ä»¥æ ¹æ®è·¯å¾„æ¥åŒºåˆ†è¿”å›æ‰§è¡Œä¸åŒçš„ä¸­é—´ä»¶

> å¦‚æœä¸­é—´å‡ºé”™ï¼Œå®ƒä¼šç›´æ¥æ‰¾åˆ°é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ¥è¿›è¡Œå¤„ç†

`app.use`å°†ä¼ å…¥çš„å‚æ•°ï¼ˆè·¯å¾„ã€å›è°ƒå‡½æ•°ï¼‰ä¼šè¢«å°è£…æˆ Layer å¯¹è±¡ï¼ˆå…¶ä¸­ route å±æ€§ä¸º undefinedï¼‰ï¼Œpush åˆ° app.\_router.stack

`app.get` ä¼šåšä¸¤ä»¶äº‹

1. é¦–å…ˆæ ¹æ®ä¼ å…¥çš„è·¯å¾„å°è£…ä¸€ä¸ª Route å¯¹è±¡ï¼Œå†å¯¹ä¼ å…¥çš„å›è°ƒå‡½æ•°å°è£…æˆ Layer å¯¹è±¡ï¼Œæ¥ç€æŠŠè¿™ä¸ª Layer å¯¹è±¡ push åˆ° Route.stack é‡Œé¢å»

2. å†åˆ›å»ºä¸€ä¸ªé»˜è®¤ Layer(è·Ÿ app.use é‡Œé¢ Layer çš„åŒçº§)ï¼ŒæŠŠæ­¥éª¤ä¸€ä¸­çš„ Route æŒ‚åˆ°è¿™ä¸ª Layer.route å±æ€§ä¸Šé¢ï¼Œè€Œè¿™ä¸ª Layer å¯¹è±¡ï¼Œä¼šè¢« push åˆ° app.\_router.stack é‡Œé¢

é¦–å…ˆåœ¨ test.js é‡Œé¢ï¼Œapp.use è°ƒç”¨ï¼Œé‚£ä¹ˆæ¥çœ‹ app å¯¹è±¡æ˜¯æ€ä¹ˆæ¥çš„

```js
var express = require("./lib/express.js");

var app = express();
```

åœ¨`./lib/express.js`é‡Œé¢å¹¶æ²¡æœ‰ç›´æ¥å®šä¹‰ use å‡½æ•°,å®ƒæŠŠ proto çš„æ‰€æœ‰å±æ€§éƒ½å¯¼åˆ° app çš„å±æ€§ä¸Š,è€Œ proto æ˜¯ä»`./lib/application`é‡Œé¢æ¥çš„

```js
//./lib/express.js
var proto = require('./application');

....

function createApplication() {

  ...

  mixin(app, proto, false);

  ...

}
```

```js
//./lib/application
app.use = function use(fn) {
  ...
  // setup router
  this.lazyrouter();

  var router = this._router;

  fns.forEach(function (fn) {
    ...
    // restore .app property on req and res
    router.use(path, function mounted_app(req, res, next) {
      var orig = req.app;
      fn.handle(req, res, function (err) {
        req.__proto__ = orig.request;
        res.__proto__ = orig.response;
        next(err);
      });
    });
    ...

    // mounted an app

    fn.emit('mount', this);

  }, this);
  return this;
};
```

this.lazyrouter()å°±æ˜¯åŠ å…¥ queryã€expressinit ä¸­é—´ä»¶çš„å…¥å£

```js
app.lazyrouter = function lazyrouter() {
  if (!this._router) {
    this._router = new Router({
      caseSensitive: this.enabled("case sensitive routing"),
      strict: this.enabled("strict routing"),
    });
    this._router.use(query(this.get("query parser fn")));
    this._router.use(middleware.init(this));
  }
};
```

è¿™é‡Œé¢ä½¿ç”¨äº† router.useï¼Œæ‰€æœ‰ä¸­é—´ä»¶ï¼ˆè·¯ç”±ï¼‰éƒ½æ˜¯ç›´æ¥æˆ–é—´æ¥å­˜å‚¨åœ¨`app._router`ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æ‰¾ router ç›¸å…³çš„ä»£ç 

```js
//./lib/router/index.js

proto.use = function use(fn) {
  ...
  for (var i = 0; i < callbacks.length; i++) {
    var fn = callbacks[i];
    ...
    var layer = new Layer(path, {

      sensitive: this.caseSensitive,

      strict: false,

      end: false

    }, fn);
    layer.route = undefined;
    this.stack.push(layer);
  }
  ...
  return this;
};
```

è¿™ä¸€æ®µä»£ç å°±èƒ½å¾ˆæ¸…æ™°çœ‹åˆ°ï¼Œæ˜¯åˆ©ç”¨ Layer å¯¹è±¡å°è£…äº†ä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼Œç„¶å app.stack push äº†è¿™ä¸ª Layer å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ª`Layer.route=undefined`

å…³äº`app[method]`ä»£ç ,æ‹¿ app.get æ¥çœ‹

```js
//./lib/application.js

methods.forEach(function(method){
  app[method] = function(path){
    ...
    this.lazyrouter();

    var route = this._router.route(path);
    //æ‰§è¡Œ
    route[method].apply(route, slice.call(arguments, 1));
    return this;
    ...
  };
});
```

methods æ˜¯ä¸€ç»„ http è¯·æ±‚çš„ç±»å‹ï¼ŒåŒ…æ‹¬ GETã€PUTã€POST ç­‰ç­‰ï¼Œäºæ˜¯ app.get çš„å±æ€§å°±è¢«å®šä¹‰äº†

å…¶å®è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°æ‡’åŠ è½½`this.lazyrouter()`ï¼Œå¦‚æœ`test.js`ä»£ç é‡Œå…ˆè°ƒç”¨`app.get`åè°ƒç”¨`app.use`ï¼Œåˆ™`query`ã€`expressinit`ä¸¤ä¸ªä¸­é—´ä»¶æ˜¯è¿™é‡Œè§¦å‘åŠ å…¥çš„

æ ¹æ® `var route = this._router.route(path)` è¿™ä¸€è¡Œä»£ç ï¼Œå¯ä»¥çŸ¥é“éœ€è¦ç¿»`./lib/router/index.js`çš„æºç 

```js
proto.route = function route(path) {
  var route = new Route(path);

  var layer = new Layer(
    path,
    {
      sensitive: this.caseSensitive,
      strict: this.strict,
      end: true,
    },
    route.dispatch.bind(route)
  );

  layer.route = route;

  this.stack.push(layer);
  return route;
};
```

è¿™é‡Œçœ‹åˆ° route å¯¹è±¡çš„åˆ›å»ºï¼Œ`layer.route = route`ï¼Œè€Œä¸”`this._route.stack` push äº†è¿™ä¸ª layer

é‚£ä¹ˆæ ¹æ®ä¹‹å‰ç°è±¡å¯ä»¥çŒœæƒ³ `var route = new Route(path)`ï¼Œä¹Ÿæ˜¯ä¼šæœ‰ä¸€ä¸ª stack å±æ€§ï¼Œå¹¶ä¸”è¿™ä¸ª stack é‡Œé¢éƒ½æ˜¯ Layer å¯¹è±¡

```js
//./lib/router/route.js
function Route(path) {
  this.path = path;
  this.stack = [];

  debug("new %s", path);

  // route handlers for various http methods
  this.methods = {};
}
```

è¿™ä¸ªæ„é€ å‡½æ•°é‡Œé¢åªæœ‰ stackï¼Œä½†æ˜¯æ˜¯ä¸ªç©ºæ•°ç»„ï¼Œè·ŸçŒœæƒ³çš„ä¸å¤ªä¸€æ ·ï¼Œç»§ç»­åœ¨è¯¥æ–‡ä»¶é‡Œé¢æ‰¾

```js
methods.forEach(function(method){
  Route.prototype[method] = function(){
    var handles = flatten(slice.call(arguments));

    for (var i = 0; i < handles.length; i++) {
    ...

      var layer = Layer('/', {}, handle);
      layer.method = method;

      this.methods[method] = true;
      this.stack.push(layer);
    }
    ...
    return this;
  };
});
```

è¿™æ®µä»£ç è¿è¡Œï¼Œä¼šå®šä¹‰ Route.getï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ° route.stack ä¼š push(layer)ï¼Œä½†æ˜¯æœ¬èº« Route.get è¿™ä¸ªå‡½æ•°æ˜¯ä»€ä¹ˆæ—¶å€™è¿è¡Œçš„å‘¢ï¼Ÿæ¯•ç«Ÿè¿™é‡Œåªæ˜¯å®šä¹‰äº†`Route.get`

```js
//../application.js
route[method].apply(route, slice.call(arguments, 1));
```

![](https://user-gold-cdn.xitu.io/2018/3/17/162343bf6f05bb8e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

![](https://user-gold-cdn.xitu.io/2018/3/17/162343f4945f9f50?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### ä¸€ä¸ªæµç¨‹åˆ†æ

express æ–‡ä»¶é‡Œæ˜¯å¯¼å‡ºè®¸å¤š apiï¼Œåƒ expressã€express.Router ç­‰ã€‚æˆ‘ä»¬å¼€å‘æ˜¯ç”¨åˆ°çš„ express()ï¼Œå®é™…ä¸Šæ˜¯æ‰§è¡Œ createApplication()ã€‚application é‡Œæ˜¯å’Œ app ç›¸å…³çš„ apiã€‚

`router/index`é‡Œæ˜¯å’Œ router ç›¸å…³çš„ä»£ç ï¼Œrouter å¯ä»¥ç†è§£æˆè·¯ç”±å™¨ï¼ŒæŠŠå„ä¸ªè¯·æ±‚å‘ç»™ routeã€‚æˆ‘ä»¬ä¸ä¼šç›´æ¥è°ƒç”¨`router/layer`é‡Œçš„æ–¹æ³•ï¼Œlayer æ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œåœ¨ express é‡Œä¸­é—´ä»¶ã€è·¯ç”±éƒ½æ”¾åœ¨ app.\_router.stack é‡Œï¼Œstack é‡Œçš„æ¯ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ª layerã€‚

route é‡Œä¹Ÿæœ‰ä¸€ä¸ª stackï¼Œé‡Œé¢çš„å…ƒç´ ä¹Ÿæ˜¯ layerã€‚

ä»ä¸€æ®µä»£ç åˆ†æä¸‹æµç¨‹

```js
const express = require("express");
const app = express();
app.get("/", (req, res, next) => {
  res.send("Hello World");
  next();
});
app.listen(3000, () => {
  console.log("server is ok");
});
```

express()ï¼Œå®é™…è°ƒç”¨ createApplication()ï¼Œè¿”å›ä¸€ä¸ª app å‡½æ•°

```js
// express.js
var mixin = require('merge-descriptors');
var proto = require('./application');
...
function createApplication() {
  var app = function(req, res, next) {
    app.handle(req, res, next);
  };

  mixin(app, EventEmitter.prototype, false);
  mixin(app, proto, false);

  // expose the prototype that will get set on requests
  app.request = Object.create(req, {
    app: { configurable: true, enumerable: true, writable: true, value: app }
  })

  // expose the prototype that will get set on responses
  app.response = Object.create(res, {
    app: { configurable: true, enumerable: true, writable: true, value: app }
  })

  app.init();
  return app;
}
```

- è¿™ä¸ª app ä¸Šæœ‰`application.js`çš„å¯¼å‡ºå¯¹è±¡`proto`ä¸Šçš„æ‰€æœ‰æ–¹æ³•ã€‚`proto`åœ¨`application.js`é‡Œå‘½å appï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œä¸‹æ–‡éƒ½æˆä¸º appã€‚
- app ä¸Šæœ‰ä¸€ä¸ª lazyrouter()æ–¹æ³•ï¼Œä¸Šé¢å·²ç»è®²è¿‡äº†ï¼Œæ”¹æ–¹æ³•ä¸»è¦æ˜¯åˆ¤æ–­`app._router`æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ new Router èµ‹å€¼ç»™`app._router`ã€‚

`app.get`ä¸`app.use`ä¸Šé¢å·²ç»éƒ½æœ‰äº†,åœ¨è¿™å·®ä¸å¤šå°±æ˜¯

```js
app.get = function (path) {
  this.lazyrouter();
  var route = this._router.route(path);
  route[method].apply(route, slice.call(arguments, 1));
  return this;
};
```

route é‡Œæ˜¯çœŸæ­£å¤„ç†è¯·æ±‚å›è°ƒçš„å‡½æ•°ï¼Œåœ¨`route[method]`é‡Œï¼Œå¾ªç¯å‚æ•°ï¼Œæ¯æ¬¡å¾ªç¯æ–°å»ºä¸€ä¸ª layerï¼Œhandle æ˜¯`app.get`çš„å›è°ƒï¼ŒæŠŠ layer æ”¾åœ¨ route çš„ stack é‡Œã€‚route[method]é‡Œçš„æ ¸å¿ƒä»£ç æ˜¯ï¼š

```js
methods.forEach(function (method) {
  Route.prototype[method] = function () {
    var handles = flatten(slice.call(arguments));

    for (var i = 0; i < handles.length; i++) {
      var handle = handles[i];

      if (typeof handle !== "function") {
        var type = toString.call(handle);
        var msg =
          "Route." +
          method +
          "() requires a callback function but got a " +
          type;
        throw new Error(msg);
      }

      debug("%s %o", method, this.path);

      var layer = Layer("/", {}, handle);
      layer.method = method;

      this.methods[method] = true;
      this.stack.push(layer);
    }

    return this;
  };
});
```

`this._router`å³`Router`çš„å®ä¾‹,`this._router.route(path)`è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹

```js
proto.route = function route(path) {
  var route = new Route(path);
  var layer = new Layer(path, {}, route.dispatch.bind(route));
  layer.route = route;
  this.stack.push(layer);
  return route;
};
```

route æ–¹æ³•é‡Œæ–°å»ºäº†ä¸€ä¸ª Route å’Œ Layerï¼ŒLayer çš„ç¬¬ä¸‰ä¸ªå‚æ•° handleï¼Œæ˜¯ express ä¸­é—´ä»¶æ‰§è¡Œçš„æ ¸å¿ƒå†…å®¹ã€‚æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œlayer æ”¾åˆ°äº† this.stackï¼Œå…¶å®å°±æ˜¯`app._router.stack`,`app._router.stack`é‡Œå­˜æ”¾ç€ä¸­é—´ä»¶ã€‚æœ€åè¿”å› route

app.get æ‰§è¡Œç»“æŸï¼Œä¸‹é¢æ˜¯ app.listenï¼š

```js
app.listen = function listen() {
  var server = http.createServer(this);
  return server.listen.apply(server, arguments);
};
```

listen é‡Œæ˜¯ç›‘å¬åˆ›å»ºä¸€ä¸ª serverï¼ŒæŠŠå‚æ•°ä¼ ç»™ server.listenï¼ŒcreateServer çš„å›è°ƒæ˜¯ thisã€‚æˆ‘ä»¬ä» createApplication é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨çš„ app æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥è¯·æ±‚æ¥äº†ï¼Œæ‰§è¡Œ`app.handle`ã€‚`app.handle`é‡Œå®é™…æ˜¯æ‰§è¡Œäº†`this._router.handle(req, res, done)`

```js
app.handle = function handle(req, res, callback) {
  var router = this._router;

  // final handler
  var done =
    callback ||
    finalhandler(req, res, {
      env: this.get("env"),
      onerror: logerror.bind(this),
    });

  // no routes
  if (!router) {
    debug("no routes defined on app");
    done();
    return;
  }

  router.handle(req, res, done);
};
```

express é‡Œç”¨åˆ°äº†å¾ˆå¤šä»£ç†æ¨¡å¼ã€‚åœ¨`router.handle`é‡Œï¼Œå¤„ç†ä¸€äº›è¯·æ±‚çš„`url`å’Œ`params`ï¼Œè°ƒç”¨å†…éƒ¨çš„`next`æ–¹æ³•ï¼Œä»`router.stack`é‡Œæ‰¾åˆ°å’Œè¯·æ±‚åŒ¹é…çš„ layerï¼Œæœ€ç»ˆè°ƒç”¨`layer.handle_request`æ–¹æ³•ï¼Œå¹¶æŠŠ next ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚

```js
proto.handle = function handle(req, res, out) {
    .....
     self.process_params(layer, paramcalled, req, res, function (err) {
      if (err) {
        return next(layerError || err);
      }

      if (route) {
        return layer.handle_request(req, res, next);
      }

      trim_prefix(layer, layerError, layerPath, path);
    });
    .....
     if (layerError) {
      layer.handle_error(layerError, req, res, next);
    } else {
      layer.handle_request(req, res, next);
    }
    .....
}
```

`layer.handle_request`é‡Œè°ƒç”¨`this.handle`ï¼Œthis.handle æ˜¯ Layer çš„ç¬¬ä¸‰ä¸ªå‚æ•°`route.dispatch.bind(route)`ã€‚åœ¨ dispatch é‡Œæ‰§è¡Œ next æ‰¾åˆ° stack é‡Œçš„ layerï¼Œæ‰§è¡Œ layer.handle_requestï¼Œå¹¶æŠŠ next ä¼ å…¥ã€‚`layer.handle_request`æ‰§è¡Œ handleï¼Œå³ app.get çš„å›è°ƒå‡½æ•°ã€‚

```js
Layer.prototype.handle_request = function handle(req, res, next) {
  var fn = this.handle;

  if (fn.length > 3) {
    // not a standard request handler
    return next();
  }

  try {
    fn(req, res, next);
  } catch (err) {
    next(err);
  }
};
```

### è·¯ç”±

åœ¨ express é‡Œåˆ›å»ºè·¯ç”±ä¸»è¦ç”±è¿™å‡ ç§æ–¹æ³•ï¼š

- app.METHODS
- app.route().get().post()
- app.all()

express.Router()ï¼Œè¿™ä¸ªå’Œä¸Šé¢çš„æ–¹æ³•æœ‰ä¸€ç‚¹ä¸ä¸€æ ·ã€‚éœ€è¦ app.use(path,router)æ‰èƒ½ä½¿ç”¨ã€‚

è¿™é‡Œé¢çš„æ ¸å¿ƒä»£ç æ˜¯ï¼š

```js
this.lazyrouter();
var route = this._router.route(path);
route[methods](fn);
```

express åˆ›å»ºè·¯ç”±ï¼Œå®é™…ä¸Šæ˜¯å…ˆè°ƒç”¨\_router.route()ï¼Œå†è°ƒç”¨ route.METHODS

```js
proto.route = function route(path) {
  var route = new Route(path);
  var layer = new Layer(path, {}, route.dispatch.bind(route));
  layer.route = route;
  this.stack.push(layer);
  return route;
};
Route.prototype[method] = function () {
  //æŠŠå‚æ•°è½¬åŒ–æˆæ•°ç»„ handles
  for (var i = 0; i < handles.length; i++) {
    var handle = handles[i];
    var layer = Layer("/", {}, handle);
    layer.method = method;
    this.methods[method] = true;
    this.stack.push(layer);
  }
  return this;
};
```

ä» layer.route = route;å¯ä»¥å¾—å‡ºè·¯ç”±æ˜¯æŒ‚è½½ layer ä¸Šçš„

```js
//Routeçš„æ•°æ®ç»“æ„
{
    methods:{},
    path:path,
    stack:[
        Layer{
        handle:handle
        method:method
        ...
        }
    ]
}

```

### ä¸­é—´ä»¶

- ä¸­é—´ä»¶åˆ†ä¸ºï¼šåº”ç”¨çº§ä¸­é—´ä»¶ã€è·¯ç”±çº§ä¸­é—´ä»¶ã€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ã€å†…ç½®ä¸­é—´ä»¶ã€ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ã€‚
- é”™è¯¯å¤„ç†ä¸­é—´ä»¶å’Œå…¶ä»–ä¸­é—´ä»¶çš„åŒºåˆ«æ˜¯å›è°ƒå‡½æ•°æœ‰å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯å¯¹è±¡ã€‚
- ä¸­é—´ä»¶çš„ä½¿ç”¨æœ‰ä¸¤ç§ï¼šæŒ‚è½½åœ¨ appã€æŒ‚è½½åœ¨ express.Router()ã€‚

app.use é‡Œæœ€ç»ˆè°ƒç”¨ router.useï¼Œrouter.use çš„æ ¸å¿ƒä»£ç 

```js
var layer = new Layer(path, {}, fn);
layer.route = undefined;
this.stack.push(layer); //app._router.stack.push(layer)
```

app.use å’Œ app.METHODï¼Œåˆ›å»ºçš„ä¸­é—´ä»¶çš„æ•°æ®ç»“æ„æ˜¯ä¸ä¸€æ ·çš„

```js
//app.useåˆ›å»ºçš„layer
Layer{
    route:undefined,
    handle:fn
}
//app.getåˆ›å»ºçš„layer
Layer{
    route:route,
    handle:route.dispatch.bind(route)
}
```

ç”¨ app.use è°ƒç”¨ï¼Œä¸€ä¸ªç”¨ express.Router()åˆ›å»ºçš„è·¯ç”±ï¼Œå³ app.use(router)ï¼Œæ•°æ®ç»“æ„å˜ä¸º

```js
Layer{
    route:undefined,
    handle:router
}
```

å¦‚æœè·¯ç”±ä¸­é—´ä»¶è°ƒç”¨è·¯ç”±ä¸­é—´ä»¶ï¼Œrouter.use(router.use(router.get(path)))ï¼Œæœ€ç»ˆè¢« app.use(router)æ‰§è¡Œã€‚æµç¨‹å›¾å¦‚ä¸‹

![](https://user-gold-cdn.xitu.io/2018/3/18/16236ae02609b435?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

express ä¸­é—´ä»¶å¯ä»¥æŠ½è±¡æˆä¸‹é¢çš„æ ·å­

![](https://user-gold-cdn.xitu.io/2018/3/18/16236ae3f0388dbd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

Router çš„å®ä¾‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¸­é—´ä»¶å’Œè·¯ç”±ç³»ç»Ÿï¼Œå› æ­¤å¸¸ç§°å…¶ä¸ºä¸€ä¸ª â€œmini-appâ€ã€‚app çš„ use å’Œå®šä¹‰è·¯ç”±æ–¹æ³•å¾ˆå¤šéƒ½æ˜¯é€šè¿‡ Router å®ç°çš„ã€‚

appã€Routerã€Routeã€Layer çš„ä¸»è¦æ•°æ®ç»“æ„å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤º

![](https://user-gold-cdn.xitu.io/2018/3/18/16236ae7eb5cd720?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

```js
//lib\middleware\init.js
var setPrototypeOf = require("setprototypeof");
exports.init = function (app) {
  return function expressInit(req, res, next) {
    if (app.enabled("x-powered-by")) res.setHeader("X-Powered-By", "Express");
    req.res = res;
    res.req = req;
    req.next = next;

    setPrototypeOf(req, app.request);
    setPrototypeOf(res, app.response);

    res.locals = res.locals || Object.create(null);

    next();
  };
};
```
