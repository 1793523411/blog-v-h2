---
time: 2021-04-09
icon: template
category: é¢è¯•
article: false
sidebar: auto
footer: ğŸ˜ğŸ˜ğŸ˜
tag:
  - å‰ç«¯
  - nodejs
---

# koa summary

## koa2

### ç›®å½•ç»“æ„

application.js æ˜¯ koa çš„å…¥å£æ–‡ä»¶ï¼Œå®ƒå‘å¤–å¯¼å‡ºäº†åˆ›å»º class å®ä¾‹çš„æ„é€ å‡½æ•°ï¼Œå®ƒç»§æ‰¿äº† eventsï¼Œè¿™æ ·å°±ä¼šèµ‹äºˆæ¡†æ¶äº‹ä»¶ç›‘å¬å’Œäº‹ä»¶è§¦å‘çš„èƒ½åŠ›ã€‚application è¿˜æš´éœ²äº†ä¸€äº›å¸¸ç”¨çš„ apiï¼Œæ¯”å¦‚ toJSONã€listenã€use ç­‰ç­‰ã€‚

listen çš„å®ç°åŸç†å…¶å®å°±æ˜¯å¯¹ http.createServer è¿›è¡Œäº†ä¸€ä¸ªå°è£…ï¼Œé‡ç‚¹æ˜¯è¿™ä¸ªå‡½æ•°ä¸­ä¼ å…¥çš„ callbackï¼Œå®ƒé‡Œé¢åŒ…å«äº†ä¸­é—´ä»¶çš„åˆå¹¶ï¼Œä¸Šä¸‹æ–‡çš„å¤„ç†ï¼Œå¯¹ res çš„ç‰¹æ®Šå¤„ç†ã€‚

use æ˜¯æ”¶é›†ä¸­é—´ä»¶ï¼Œå°†å¤šä¸ªä¸­é—´ä»¶æ”¾å…¥ä¸€ä¸ªç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œç„¶åé€šè¿‡ koa-compose è¿™ä¸ªæ’ä»¶è¿›è¡Œé€’å½’ç»„åˆè°ƒç”¨è¿™ä¸€äº›åˆ—çš„ä¸­é—´ä»¶

context.js æ˜¯ koa çš„åº”ç”¨ä¸Šä¸‹æ–‡ ctx,å…¶å®å°±ä¸€ä¸ªç®€å•çš„å¯¹è±¡æš´éœ²ï¼Œé‡Œé¢çš„é‡ç‚¹åœ¨ `delegate`ï¼Œè¿™ä¸ªå°±æ˜¯ä»£ç†ï¼Œè¿™ä¸ªå°±æ˜¯ä¸ºäº†å¼€å‘è€…æ–¹ä¾¿è€Œè®¾è®¡çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦è®¿é—® `ctx.repsponse.status` ä½†æ˜¯æˆ‘ä»¬é€šè¿‡ `delegate`ï¼Œå¯ä»¥ç›´æ¥è®¿é—® `ctx.status` è®¿é—®åˆ°å®ƒ

`request.js`ã€`response.js`,è¿™ä¸¤éƒ¨åˆ†å°±æ˜¯å¯¹åŸç”Ÿçš„ resã€req çš„ä¸€äº›æ“ä½œäº†ï¼Œå¤§é‡ä½¿ç”¨ es6 çš„ get å’Œ set çš„ä¸€äº›è¯­æ³•ï¼Œå»å– headers æˆ–è€…è®¾ç½® headersã€è¿˜æœ‰è®¾ç½® body ç­‰ç­‰

### ä¸»è¦æµç¨‹

koa ä¸»è¦å°±æ˜¯å››ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œæ´‹è‘±æ¨¡å‹ï¼ˆæŠŠä¸­é—´ä»¶ä¸²è”èµ·æ¥ï¼‰ï¼Œhttp è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰ã€http è¯·æ±‚å¯¹è±¡ã€http å“åº”å¯¹è±¡

![](https://user-gold-cdn.xitu.io/2020/3/12/170ce29e90274d42?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

ä¸‹é¢æ˜¯ koa çš„ä¸€ä¸ªä¸»è¦æµç¨‹

```js
const Emitter = require("events");

class Emitter {
  // node å†…ç½®æ¨¡å—
  constructor() {}
}
class Koa extends Emitter {
  constructor(options) {
    super();
    options = options || {};
    this.middleware = [];
    this.context = {
      method: "GET",
      url: "/url",
      body: undefined,
      set: function(key, val) {
        console.log("context.set", key, val);
      },
    };
  }
  use(fn) {
    this.middleware.push(fn);
    return this;
  }
  listen() {
    const fnMiddleware = compose(this.middleware);
    const ctx = this.context;
    const handleResponse = () => respond(ctx);
    const onerror = function() {
      console.log("onerror");
    };
    fnMiddleware(ctx)
      .then(handleResponse)
      .catch(onerror);
  }
}
function respond(ctx) {
  console.log("handleResponse");
  console.log("response.end", ctx.body);
}
```

é‡ç‚¹å°±åœ¨ listen å‡½æ•°é‡Œçš„ compose è¿™ä¸ªå‡½æ•°

### koa-compose

**koa-compose æ˜¯å°† app.use æ·»åŠ åˆ° middleware æ•°ç»„ä¸­çš„ä¸­é—´ä»¶ï¼ˆå‡½æ•°ï¼‰ï¼Œé€šè¿‡ä½¿ç”¨ Promise ä¸²è”èµ·æ¥ï¼Œnext()è¿”å›çš„æ˜¯ä¸€ä¸ª promise**

é€šè¿‡ app.use() æ·»åŠ äº†è‹¥å¹²å‡½æ•°ï¼Œä½†æ˜¯è¦æŠŠå®ƒä»¬ä¸²èµ·æ¥æ‰§è¡Œå‘€ï¼Œcompose å‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ªæ•°ç»„ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚å¯¹å…¥å‚æ˜¯ä¸æ˜¯æ•°ç»„å’Œæ ¡éªŒæ•°ç»„æ¯ä¸€é¡¹æ˜¯ä¸æ˜¯å‡½æ•°

```js
function compose(middleware) {
  // æ ¡éªŒmiddleware æ˜¯æ•°ç»„å’Œæ•°ç»„æ¯ä¸€é¡¹éƒ½æ˜¯å‡½æ•°çš„æ ¡éªŒ

  if (!Array.isArray(middleware))
    throw new TypeError("Middleware stack must be an array!");
  for (const fn of middleware) {
    if (typeof fn !== "function")
      throw new TypeError("Middleware must be composed of functions!");
  }

  return function(context, next) {
    // last called middleware #
    let index = -1;
    return dispatch(0);
    function dispatch(i) {
      if (i <= index)
        return Promise.reject(new Error("next() called multiple times"));
      index = i;
      let fn = middleware[i];
      if (i === middleware.length) fn = next;
      if (!fn) return Promise.resolve();
      try {
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err);
      }
    }
  };
}
```

compose å°±æ˜¯ç±»ä¼¼è¿™æ ·çš„ç»“æ„ï¼ˆç§»é™¤ä¸€äº›åˆ¤æ–­ï¼‰

```js
// è¿™æ ·å°±å¯èƒ½æ›´å¥½ç†è§£äº†ã€‚
// simpleKoaCompose
const [fn1, fn2, fn3] = this.middleware;
const fnMiddleware = function(context) {
  return Promise.resolve(
    fn1(context, function next() {
      return Promise.resolve(
        fn2(context, function next() {
          return Promise.resolve(
            fn3(context, function next() {
              return Promise.resolve();
            })
          );
        })
      );
    })
  );
};
fnMiddleware(ctx)
  .then(handleResponse)
  .catch(onerror);
```

ä¹Ÿå°±æ˜¯è¯´ koa-compose è¿”å›çš„æ˜¯ä¸€ä¸ª Promiseï¼ŒPromise ä¸­å–å‡ºç¬¬ä¸€ä¸ªå‡½æ•°ï¼ˆapp.use æ·»åŠ çš„ä¸­é—´ä»¶ï¼‰ï¼Œä¼ å…¥ context å’Œç¬¬ä¸€ä¸ª next å‡½æ•°æ¥æ‰§è¡Œã€‚

ç¬¬ä¸€ä¸ª next å‡½æ•°é‡Œä¹Ÿæ˜¯è¿”å›çš„æ˜¯ä¸€ä¸ª Promiseï¼ŒPromise ä¸­å–å‡ºç¬¬äºŒä¸ªå‡½æ•°ï¼ˆapp.use æ·»åŠ çš„ä¸­é—´ä»¶ï¼‰ï¼Œä¼ å…¥ context å’Œç¬¬äºŒä¸ª next å‡½æ•°æ¥æ‰§è¡Œã€‚

ç¬¬äºŒä¸ª next å‡½æ•°é‡Œä¹Ÿæ˜¯è¿”å›çš„æ˜¯ä¸€ä¸ª Promiseï¼ŒPromise ä¸­å–å‡ºç¬¬ä¸‰ä¸ªå‡½æ•°ï¼ˆapp.use æ·»åŠ çš„ä¸­é—´ä»¶ï¼‰ï¼Œä¼ å…¥ context å’Œç¬¬ä¸‰ä¸ª next å‡½æ•°æ¥æ‰§è¡Œã€‚

ç¬¬ä¸‰ä¸ª...

ä»¥æ­¤ç±»æ¨ã€‚æœ€åä¸€ä¸ªä¸­é—´ä»¶ä¸­æœ‰è°ƒç”¨ next å‡½æ•°ï¼Œåˆ™è¿”å› Promise.resolveã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸æ‰§è¡Œ next å‡½æ•°ã€‚

è¿™æ ·å°±æŠŠæ‰€æœ‰ä¸­é—´ä»¶ä¸²è”èµ·æ¥äº†ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æ´‹è‘±æ¨¡å‹ã€‚

è¿™ç§æŠŠå‡½æ•°å­˜å‚¨ä¸‹æ¥çš„æ–¹å¼ï¼Œåœ¨å¾ˆå¤šæºç ä¸­éƒ½æœ‰çœ‹åˆ°ã€‚æ¯”å¦‚ lodash æºç çš„æƒ°æ€§æ±‚å€¼ï¼Œvuex ä¹Ÿæ˜¯æŠŠ action ç­‰å‡½æ•°å­˜å‚¨ä¸‹ï¼Œæœ€åæ‰å»è°ƒç”¨

::: tip å¦å¤–ä¸€ç§ compose å®ç°æ€è·¯

```js
    compose() {
        return async ctx => {
            function createNext(middleware, oldNext) {
                return async () => {
                    await middleware(ctx, oldNext);
                }
            }
            let len = this.middlewares.length;
            let next = async () => {
                return Promise.resolve();
            };
            for (let i = len - 1; i >= 0; i--) {
                let currentMiddleware = this.middlewares[i];
                next = createNext(currentMiddleware, next);
            }
            await next();
        };
    }

    callback() {
        return (req, res) => {
            let ctx = this.createContext(req, res);
            let respond = () => this.responseBody(ctx);
            let onerror = (err) => this.onerror(err, ctx);
            let fn = this.compose();
            return fn(ctx);
        };
    }

```

:::

### koa-convert

**koa-convert åˆ¤æ–­ app.use ä¼ å…¥çš„å‡½æ•°æ˜¯å¦æ˜¯ generator å‡½æ•°ï¼Œå¦‚æœæ˜¯åˆ™ç”¨ koa-convert æ¥è½¬æ¢ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨çš„ co æ¥è½¬æ¢,co æºç å®ç°åŸç†ï¼šå…¶å®å°±æ˜¯é€šè¿‡ä¸æ–­çš„è°ƒç”¨ generator å‡½æ•°çš„ next()å‡½æ•°ï¼Œæ¥è¾¾åˆ°è‡ªåŠ¨æ‰§è¡Œ generator å‡½æ•°çš„æ•ˆæœï¼ˆç±»ä¼¼ asyncã€await å‡½æ•°çš„è‡ªåŠ¨è‡ªè¡Œï¼‰**

app.use æ—¶æœ‰ä¸€å±‚åˆ¤æ–­ï¼Œæ˜¯å¦æ˜¯ generator å‡½æ•°ï¼Œå¦‚æœæ˜¯åˆ™ç”¨ koa-convert æš´éœ²çš„æ–¹æ³• convert æ¥è½¬æ¢é‡æ–°èµ‹å€¼ï¼Œå†å­˜å…¥ middlewareï¼Œåç»­å†ä½¿ç”¨

```js
class Koa extends Emitter {
  use(fn) {
    if (typeof fn !== "function")
      throw new TypeError("middleware must be a function!");
    if (isGeneratorFunction(fn)) {
      deprecate(
        "Support for generators will be removed in v3. " +
          "See the documentation for examples of how to convert old middleware " +
          "https://github.com/koajs/koa/blob/master/docs/migration.md"
      );
      fn = convert(fn);
    }
    debug("use %s", fn._name || fn.name || "-");
    this.middleware.push(fn);
    return this;
  }
}
```

koa-convert æºç æŒºå¤šï¼Œæ ¸å¿ƒä»£ç å…¶å®æ˜¯è¿™æ ·çš„

```js
function convert() {
  return function(ctx, next) {
    return co.call(ctx, mw.call(ctx, createGenerator(next)));
  };
  function* createGenerator(next) {
    return yield next();
  }
}
```

æœ€åè¿˜æ˜¯é€šè¿‡ co æ¥è½¬æ¢çš„

```js
function co(gen) {
  var ctx = this;
  var args = slice.call(arguments, 1);
  return new Promise(function(resolve, reject) {
    // æŠŠå‚æ•°ä¼ é€’ç»™genå‡½æ•°å¹¶æ‰§è¡Œ
    if (typeof gen === "function") gen = gen.apply(ctx, args);
    // å¦‚æœä¸æ˜¯å‡½æ•° ç›´æ¥è¿”å›
    if (!gen || typeof gen.next !== "function") return resolve(gen);

    onFulfilled();

    function onFulfilled(res) {
      var ret;
      try {
        ret = gen.next(res);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }

    function onRejected(err) {
      var ret;
      try {
        ret = gen.throw(err);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }

    // åå¤æ‰§è¡Œè°ƒç”¨è‡ªå·±
    function next(ret) {
      // æ£€æŸ¥å½“å‰æ˜¯å¦ä¸º Generator å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œå¦‚æœæ˜¯å°±è¿”å›esolve(ret.value);
      if (ret.done) return r;
      // ç¡®ä¿è¿”å›å€¼æ˜¯promiseå¯¹è±¡ã€‚
      var value = toPromise.call(ctx, ret.value);
      // ä½¿ç”¨ then æ–¹æ³•ï¼Œä¸ºè¿”å›å€¼åŠ ä¸Šå›è°ƒå‡½æ•°ï¼Œç„¶åé€šè¿‡ onFulfilled å‡½æ•°å†æ¬¡è°ƒç”¨ next å‡½æ•°ã€‚
      if (value && isPromise(value)) return value.then(onFulfilled, onRejected);
      // åœ¨å‚æ•°ä¸ç¬¦åˆè¦æ±‚çš„æƒ…å†µä¸‹ï¼ˆå‚æ•°é Thunk å‡½æ•°å’Œ Promise å¯¹è±¡ï¼‰ï¼Œå°† Promise å¯¹è±¡çš„çŠ¶æ€æ”¹ä¸º rejectedï¼Œä»è€Œç»ˆæ­¢æ‰§è¡Œã€‚
      return onRejected(
        new TypeError(
          "You may only yield a function, promise, generator, array, or object, " +
            'but the following object was passed: "' +
            String(ret.value) +
            '"'
        )
      );
    }
  });
}
```

### é”™è¯¯å¤„ç†

æ–‡æ¡£ä¸­å†™äº†ä¸‰ç§æ•è·é”™è¯¯çš„æ–¹å¼ã€‚

- ctx.onerror ä¸­é—´ä»¶ä¸­çš„é”™è¯¯æ•è·
- app.on('error', (err) => {}) æœ€å¤–å±‚å®ä¾‹äº‹ä»¶ç›‘å¬å½¢å¼ä¹Ÿå¯ä»¥çœ‹çœ‹ä¾‹å­ koajs/examples/errors/app.js æ–‡ä»¶
- app.onerror = (err) => {} é‡å†™ onerror è‡ªå®šä¹‰å½¢å¼

`lib/context.js`æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªå‡½æ•° onerrorï¼Œè€Œä¸”æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç `this.app.emit('error', err, this)`

```js
module.exports = {
  onerror() {
    // delegate
    // app æ˜¯åœ¨new Koa() å®ä¾‹
    this.app.emit("error", err, this);
  },
};
```

```js
app.use(async (ctx, next) => {
  try {
    await next();
  } catch (err) {
    err.status = err.statusCode || err.status || 500;
    throw err;
  }
});
```

try catch é”™è¯¯æˆ–è¢«`fnMiddleware(ctx).then(handleResponse).catch(onerror);`ï¼Œè¿™é‡Œçš„ onerror æ˜¯ ctx.onerror

è€Œ ctx.onerror å‡½æ•°ä¸­åˆè°ƒç”¨äº†`this.app.emit('error', err, this)`ï¼Œæ‰€ä»¥åœ¨æœ€å¤–å›´`app.on('error'ï¼Œerr => {})`å¯ä»¥æ•è·ä¸­é—´ä»¶é“¾ä¸­çš„é”™è¯¯ã€‚

å› ä¸º koa ç»§æ‰¿è‡ª events æ¨¡å—ï¼Œæ‰€ä»¥æœ‰ emit å’Œ on ç­‰æ–¹æ³•

### æ‰§è¡Œæµç¨‹

```js
const Koa = require("koa");
const app = new Koa();

app.use((ctx) => {
  ctx.body = "Hello Koa";
});

app.listen(3000);
```

![](https://pic4.zhimg.com/80/v2-f0731a5f944119b3b59bde4d1bf3f58b_720w.jpg)

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº† Koa çš„å®ä¾‹ appï¼Œå…¶æ„é€ å‡½æ•°ååˆ†ç®€å•ï¼Œå¦‚ä¸‹:

```js
constructor() {
  super();
  this.proxy = false;
  this.middleware = [];
  this.subdomainOffset = 2;
  this.env = process.env.NODE_ENV || 'development';
  this.context = Object.create(context);
  this.request = Object.create(request);
  this.response = Object.create(response);
}
```

è¿™ä¸ªä»£ç å¾ˆç®€å•ï¼Œå…¶ä¸­ context ã€request å’Œ response å°±æ˜¯ 3 ä¸ªå­—é¢é‡å½¢å¼åˆ›å»ºçš„ç®€å•å¯¹è±¡ï¼Œä¸Šé¢å°è£…äº†ä¸€äº›åˆ—æ–¹æ³•ï¼ˆå…¶å®ç»å¤§éƒ¨åˆ†æ˜¯å±æ€§çš„èµ‹å€¼å™¨ï¼ˆsetterï¼‰å’Œå–å€¼å™¨ï¼ˆgetterï¼‰ï¼‰ï¼Œæš‚æ—¶ä¸ç”¨ç®¡å®ƒä»¬ã€‚å°±åƒç¤ºæ„å›¾æ‰€ç¤ºï¼Œä»–ä»¬å°†ä½œä¸º app ç›¸åº”å±æ€§çš„åŸå‹ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ Application æ˜¯ç»§æ‰¿äº EventEmitterï¼Œå¦‚ä¸‹ï¼š

```js
class Application extends Emitter { //... }
```

æ¥ä¸‹æ¥ä½¿ç”¨ use çš„æ–¹æ³•æ³¨å†Œä¸€ä¸ªä¸­é—´ä»¶ï¼Œå…¶å®å°±æ˜¯ç®€å•çš„ push åˆ°è‡ªèº«çš„ mideware è¿™ä¸ªæ•°ç»„ä¸­ã€‚å¦‚ä¸‹ï¼š

```js
use(fn) {
  // çœç•¥äº†ä¸€ç‚¹ç‚¹æ ¡éªŒå‚æ•°æ€§è´¨çš„ä»£ç 
  this.middleware.push(fn);
  return this;
}
```

æ ¸å¿ƒçš„ä»£ç åœ¨ listen è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å®ƒåšçš„äº‹ä»¶ä¹Ÿå¾ˆç®€å•ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œé€šè¿‡å‘ http.createServer ä¼ é€’ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°çš„å½¢å¼æ¥åˆ›å»ºå…¶çš„ä¸€ä¸ªå®ä¾‹ï¼Œå…¶å® app.listen é‡Œé¢å°±åšäº†è¿™ä¸ªä¸€ä¸ªäº‹æƒ…ï¼Œæºç ä¾æ—§ååˆ†ç®€å•ï¼š

```js
listen() {
  const server = http.createServer(this.callback());
  return server.listen.apply(server, arguments);
}

```

å”¯ä¸€éœ€è¦æˆ‘ä»¬å…³æ³¨çš„å°±æ˜¯è¿™ä¸ª this.callback ï¼Œä¹Ÿæ˜¯ç†è§£ koa åº”ç”¨çš„æ ¸å¿ƒæ‰€åœ¨ã€‚

this.callback() æ‰§è¡Œçš„ç»“æœè‚¯å®šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ— éå°±æ˜¯æ ¹æ® req è·å–ä¿¡æ¯ï¼ŒåŒæ—¶å‘ res ä¸­å†™å…¥æ•°æ®è€Œå·²ã€‚

é‚£ä¹ˆè¿™ä¸ªå‡½æ•°å…·ä½“æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿé¦–å…ˆï¼Œå®ƒåŸºäº req å’Œ res å°è£…å‡ºæˆ‘ä»¬ä¸­é—´ä»¶æ‰€ä½¿ç”¨çš„ ctx å¯¹è±¡ï¼Œå†å°† ctx ä¼ é€’ç»™ä¸­é—´ä»¶æ‰€ç»„åˆæˆçš„ä¸€ä¸ªåµŒå¥—å‡½æ•°ã€‚ä¸­é—´ä»¶ç»„åˆçš„åµŒå¥—å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Promise çš„å®ä¾‹ï¼Œç­‰åˆ°è¿™ä¸ªç»„åˆå‡½æ•°æ‰§è¡Œå®Œï¼ˆ resolve )ï¼Œé€šè¿‡ ctx ä¸­çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ ctx.body ï¼‰æƒ³ res ä¸­å†™å…¥æ•°æ®ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™ ï¼ˆrejectï¼‰ï¼Œè¿™è°ƒç”¨é»˜è®¤çš„é”™è¯¯å¤„ç†å‡½æ•°ã€‚

```js
callback() {
  const fn = compose(this.middleware);

  if (!this.listeners('error').length) this.on('error', this.onerror);

  return (req, res) => {
    res.statusCode = 404;
    const ctx = this.createContext(req, res);
    const onerror = err => ctx.onerror(err);
    onFinished(res, onerror);
    fn(ctx).then(() => respond(ctx)).catch(onerror);
  };
}
```

callback é¦–å…ˆä¼šå°†æˆ‘ä»¬çš„ä¸­é—´ä»¶ç»„åˆæˆä¸ºä¸€ä¸ªåµŒå¥—å‡½æ•°ä¾›è¿”å›çš„å‡½æ•°æ‰§è¡Œæ—¶è°ƒç”¨ã€‚createContext æ ¹æ® req å’Œ res å°è£…ä¸­é—´ä»¶æ‰€éœ€è¦çš„ ctxã€‚onFinished æ˜¯ç¡®ä¿ä¸€ä¸ªæµåœ¨å…³é—­ã€å®Œæˆå’ŒæŠ¥é”™æ—¶éƒ½ä¼šæ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚onerror å°±æ˜¯æˆ‘ä»¬é”™è¯¯å¤„ç†å‡½æ•°ï¼Œæœ€ååˆ†æã€‚respond å°±æ˜¯æˆ‘ä»¬æ ¹æ® ctx ä¸­çš„æ•°æ®ï¼Œç„¶åé›†ä¸­çš„å‘ res ä¸­å†™å…¥æ•°æ®ï¼Œå“åº” http è¯·æ±‚

ç°åœ¨æ ¸å¿ƒæ˜¯ createContext æ˜¯å¦‚ä½•å°è£…å‡º ctx çš„ï¼Œç›´æ¥çœ‹æºç 

```js
createContext(req, res) {
  const context = Object.create(this.context);
  const request = context.request = Object.create(this.request);
  const response = context.response = Object.create(this.response);

  context.app = request.app = response.app = this;
  context.req = request.req = response.req = req;
  context.res = request.res = response.res = res;
  request.ctx = response.ctx = context;
  // çœç•¥ä¸€ç‚¹æ— å…³ç´§è¦çš„ä»£ç 
  return context;
}
```

ç®€å•çš„è¯´å°±æ˜¯åˆ›å»ºäº† 3 ä¸ªç®€å•çš„å¯¹è±¡ï¼Œå¹¶ä¸”å°†ä»–ä»¬çš„åŸå‹æŒ‡å®šä¸ºæˆ‘ä»¬ app ä¸­å¯¹åº”çš„å¯¹è±¡ã€‚ç„¶åå°†åŸç”Ÿçš„ req å’Œ res èµ‹å€¼ç»™ç›¸åº”çš„å±æ€§ï¼Œå°±å®Œæˆäº†ã€‚

ä½†æ˜¯ï¼Œctx ä¸Šä¸æ˜¯æš´éœ²å‡ºæ¥å¾ˆå¤šå±æ€§å—ï¼Ÿå®ƒä»¬åœ¨å“ªï¼Ÿä»–ä»¬å°±åœ¨æˆ‘ä»¬ç¤ºæ„å›¾çš„æœ€å³è¾¹ï¼Œä¸€å¼€å§‹æˆ‘ä»¬ç•¥è¿‡çš„ 3 ä¸ªç®€å•å¯¹è±¡ã€‚é€šè¿‡åŸå‹é“¾çš„å½¢å¼ï¼Œæˆ‘ä»¬ ctx.request æ‰€èƒ½è®¿é—®å±æ€§å’Œæ–¹æ³•ç»å¤§éƒ¨åˆ†éƒ½åœ¨å…¶å¯¹åº”çš„ request è¿™ä¸ªç®€å•çš„å¯¹è±¡ä¸Šé¢ã€‚request åˆæ˜¯æ€ä¹ˆå°è£…çš„å‘¢ï¼Ÿ

```js
module.exports = {
  //...
  get method() {
    return this.req.method;
  },

  set method(val) {
    this.req.method = val;
  },
  //...
};
```

æ‰€ä»¥è®¿é—® `ctx.request.xxx` å±æ€§éƒ½æ˜¯å®šä¹‰åœ¨å³è¾¹ resquest è¿™ä¸ªç®€å•å¯¹è±¡ä¸Šçš„å±æ€§çš„èµ‹å€¼å™¨ï¼ˆsetterï¼‰å’Œå–å€¼å™¨ï¼ˆgetterï¼‰,response åŒç†

å€¼å¾—ä¸€æçš„æ˜¯å³è¾¹ context è¿™ä¸ªå¯¹è±¡ä¸Šé¢åªæä¾›äº†æå°‘çš„æ–¹æ³•ï¼Œå…¶ä»–å±æ€§éƒ½æ˜¯ç®€å•çš„ä»£ç†åˆ°è‡ªèº«çš„ request å’Œ response è¿™ä¸¤ä¸ªå¯¹è±¡ä¸Š

æœ€åç®€å•çš„åˆ†æä¸€ä¸‹é”™è¯¯å¤„ç†ï¼Œç”±ä¹‹å‰ callback ä¸­çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œapp ä¼šé»˜è®¤æ³¨å†Œä¸€ä¸ªé”™è¯¯å¤„ç†å‡½æ•°ã€‚

```js
if (!this.listeners("error").length) this.on("error", this.onerror);
```

ä½†æ˜¯æˆ‘ä»¬æ¯æ¬¡ http è¯·æ±‚çš„é”™è¯¯å…¶å®æ˜¯äº¤ä¸ª ctx.onerror å¤„ç†çš„ï¼š

```js
const onerror = (err) => ctx.onerror(err);
onFinished(res, onerror);
fn(ctx)
  .then(() => respond(ctx))
  .catch(onerror);
```

onFinished æ˜¯ç¡®ä¿ä¸€ä¸ªæµåœ¨å…³é—­ã€å®Œæˆå’ŒæŠ¥é”™æ—¶éƒ½ä¼šæ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚ctx.onerror è¿™ä¸ªå‡½æ•°åœ¨å‚æ•°ä¸ºç©ºæˆ–è€… null çš„æ—¶å€™ï¼Œç›´æ¥è¿”å›ï¼Œä¸ä¼šåšä»»ä½•æ“ä½œã€‚

```js
if (null == err) return;
```

å¦åˆ™ï¼Œåˆ™ä¼šè§¦å‘ app äº§ç”Ÿä¸€ä¸ªé”™è¯¯äº‹ä»¶ã€‚

```js
this.app.emit("error", err, this);
```

ç„¶åå¦‚æœåˆ¤æ–­è¯¥è¯·æ±‚å¤„ç†ä¾æ—§æ²¡æœ‰ç»“æŸï¼Œä¹Ÿå°±æ˜¯ app æ³¨å†Œçš„ onerror äº‹ä»¶æ²¡æœ‰ç»“æŸè¯¥è¯·æ±‚ï¼Œåˆ™ä¼šå°è¯•å‘å®¢æˆ·ç«¯äº§ç”Ÿä¸€ä¸ª 500 çš„é”™è¯¯ã€‚åˆ¤æ–­æ–¹å¼ï¼š

```js
if (this.headerSent || !this.writable) {
  err.headerSent = true;
  return;
}
```

æ€»ç»“èµ·æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸åŒçš„æŠ½è±¡å±‚æ¬¡ä¸Šå¤„ç†é”™è¯¯ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é¡¶å±‚çš„ä¸­é—´ä»¶å°†æ‰€æœ‰ä¸­é—´ä»¶äº§ç”Ÿçš„é”™è¯¯æ•è·å¹¶å¤„ç†äº†ï¼Œè¿™æ ·é”™è¯¯å°±ä¸ä¼šè¢«ä¸Šå±‚æ•è·ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è¦†ç›– ctx.onerror çš„æ–¹å¼æ¥æ•è·æ‰€æœ‰çš„å¼‚å¸¸ï¼Œè€Œä¸”å¯ä»¥ä¸è§¦å‘ app çš„ error äº‹ä»¶ã€‚æœ€åæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ç›‘å¬ app çš„ error äº‹ä»¶çš„æ–¹å¼æ¥å¤„ç†é”™è¯¯ã€‚

### koa ä¸ express çš„åŒºåˆ«

åœ¨ç†å¿µä¸Šï¼ŒKoa æ—¨åœ¨ â€œä¿®å¤å’Œæ›¿æ¢èŠ‚ç‚¹â€ï¼Œè€Œ Express æ—¨åœ¨ â€œå¢åŠ èŠ‚ç‚¹â€ã€‚ Koa ä½¿ç”¨ Promise(JavaScript ä¸€ç§å¼‚æ­¥æ‰‹æ®µ)å’Œå¼‚æ­¥åŠŸèƒ½æ¥æ‘†è„±å›è°ƒåœ°ç‹±çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ç®€åŒ–é”™è¯¯å¤„ç†ã€‚ å®ƒæš´éœ²äº†è‡ªå·±çš„ ctx.request å’Œ ctx.response å¯¹è±¡ï¼Œè€Œä¸æ˜¯ node çš„ req å’Œ res å¯¹è±¡ã€‚

å¦ä¸€æ–¹é¢ï¼ŒExpress é€šè¿‡é™„åŠ çš„å±æ€§å’Œæ–¹æ³•å¢åŠ äº† node çš„ req å’Œ res å¯¹è±¡ï¼Œå¹¶ä¸”åŒ…å«è®¸å¤šå…¶ä»– â€œæ¡†æ¶â€ åŠŸèƒ½ï¼Œå¦‚è·¯ç”±å’Œæ¨¡æ¿ï¼Œè€Œ Koa åˆ™æ²¡æœ‰ã€‚

å› æ­¤ï¼ŒKoa å¯è¢«è§†ä¸º node.js çš„ http æ¨¡å—çš„æŠ½è±¡ï¼Œå…¶ä¸­ Express æ˜¯ node.js çš„åº”ç”¨ç¨‹åºæ¡†æ¶ã€‚

koa å®ƒæ›´åƒæ˜¯ Connectï¼Œå¾ˆå¤š Express çš„å¥½ä¸œè¥¿è¢«è½¬ç§»åˆ° Koa çš„ä¸­é—´ä»¶çº§åˆ«ï¼Œä»¥å¸®åŠ©å½¢æˆæ›´å¼ºå¤§çš„åŸºç¡€ã€‚ è¿™ä½¿å¾—ä¸­é—´ä»¶å¯¹äºæ•´ä¸ªå †æ ˆè€Œè¨€ä¸ä»…ä»…æ˜¯æœ€ç»ˆåº”ç”¨ç¨‹åºä»£ç ï¼Œè€Œä¸”æ›´æ˜“äºä¹¦å†™ï¼Œå¹¶æ›´ä¸å®¹æ˜“å‡ºé”™ã€‚

::: tip åŸºäº Promises çš„æ§åˆ¶æµç¨‹
æ²¡æœ‰å›è°ƒåœ°ç‹±ã€‚

é€šè¿‡ try/catch æ›´å¥½çš„å¤„ç†é”™è¯¯ã€‚
:::

::: tip Koa éå¸¸ç²¾ç®€
ä¸åŒäº Connect å’Œ Express, Koa ä¸å«ä»»ä½•ä¸­é—´ä»¶.

ä¸åŒäº Express, ä¸æä¾›è·¯ç”±.

ä¸åŒäº Express, ä¸æä¾›è®¸å¤šä¾¿æ·è®¾æ–½ã€‚ ä¾‹å¦‚ï¼Œå‘é€æ–‡ä»¶.

:::
Koa æ›´åŠ æ¨¡å—åŒ–.

::: tip Koa å¯¹ä¸­é—´ä»¶çš„ä¾èµ–è¾ƒå°‘
ä¾‹å¦‚, ä¸ä½¿ç”¨ â€œbody parsingâ€ ä¸­é—´ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨ body è§£æå‡½æ•°ã€‚
:::

::: tip Koa æŠ½è±¡ node çš„ request/response
å‡å°‘æ”»å‡»ã€‚

æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

æ°å½“çš„æµå¤„ç†ã€‚
:::
::: tip Koa è·¯ç”±ï¼ˆç¬¬ä¸‰æ–¹åº“æ”¯æŒï¼‰
ç”±äº Express å¸¦æœ‰è‡ªå·±çš„è·¯ç”±ï¼Œè€Œ Koa æ²¡æœ‰ä»»ä½•å†…ç½®è·¯ç”±ï¼Œä½†æ˜¯æœ‰ koa-router å’Œ koa-route ç¬¬ä¸‰æ–¹åº“å¯ç”¨ã€‚åŒæ ·çš„, å°±åƒæˆ‘ä»¬åœ¨ Express ä¸­æœ‰ helmet ä¿è¯å®‰å…¨, å¯¹äº koa æˆ‘ä»¬æœ‰ koa-helmet å’Œä¸€äº›åˆ—çš„ç¬¬ä¸‰æ–¹åº“å¯ç”¨ã€‚
:::

### koa2 å’Œ koa1 çš„åŒºåˆ«

- Koa v2 å¼•å…¥äº†æ–°çš„ä¸­é—´ä»¶ç­¾åã€‚

æ–°çš„ä¸­é—´ä»¶ç­¾åæ˜¯è¿™æ ·çš„:

```js
// ä½¿ç”¨å¼‚æ­¥ç®­å¤´æ–¹æ³•
app.use(async (ctx, next) => {
  try {
    await next(); // next ç°åœ¨æ˜¯ä¸€ä¸ªæ–¹æ³•
  } catch (err) {
    ctx.body = { message: err.message };
    ctx.status = err.status || 500;
  }
});

app.use(async (ctx) => {
  const user = await User.getById(this.session.userid); // await æ›¿æ¢äº† yield
  ctx.body = user; // ctx æ›¿æ¢äº† this
});
```

ä¸å¿…ä¸€å®šä½¿ç”¨å¼‚æ­¥å‡½æ•° - ä½ åªéœ€è¦ä¼ é€’ä¸€ä¸ªè¿”å› promise çš„å‡½æ•°ã€‚è¿”å› promise çš„å¸¸è§„æ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼

ç­¾åå·²æ›´æ”¹ä¸ºé€šè¿‡ ctx å–ä»£ this æ˜¾å¼å‚æ•°ä¼ é€’ Contextã€‚

ä¸Šä¸‹æ–‡ä¼ é€’æ›´æ”¹ä½¿å¾— koa æ›´èƒ½å…¼å®¹ es6 çš„ç®­å¤´å‡½æ•°ï¼Œé€šè¿‡æ•è· â€œthisâ€

- koa1 ä¸­ä¸»è¦æ˜¯ generator å‡½æ•°ã€‚koa2 ä¸­ä¼šè‡ªåŠ¨è½¬æ¢ generator å‡½æ•°ã€‚

```js
// Koa å°†è½¬æ¢
app.use(function*(next) {
  const start = Date.now();
  yield next;
  const ms = Date.now() - start;
  console.log(`${this.method} ${this.url} - ${ms}ms`);
});
```

ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒKoa ä¸ä¼šè½¬æ¢ã€‚

```js
const convert = require("koa-convert");

app.use(
  convert(function*(next) {
    const start = Date.now();
    yield next;
    const ms = Date.now() - start;
    console.log(`${this.method} ${this.url} - ${ms}ms`);
  })
);
```

- åº”ç”¨å¯¹è±¡æ„é€ å‡½æ•°éœ€è¦ new

åœ¨ v1.x ä¸­ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨åº”ç”¨æ„é€ å‡½æ•°ï¼Œè€Œä¸ç”¨ new å®ä¾‹åŒ–ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„å®ä¾‹ã€‚ ä¾‹å¦‚ï¼š

```js
var koa = require("koa");
var app = (module.exports = koa());
```

v2.x ä½¿ç”¨ es6 ç±»ï¼Œéœ€è¦ä½¿ç”¨ new å…³é”®å­—ã€‚

```js
var koa = require("koa");
var app = (module.exports = new koa());
```

- ä¾èµ–å˜åŒ–

co ä¸å†ä¸ Koa æ†ç»‘åœ¨ä¸€èµ·ã€‚ç›´æ¥ require æˆ– import å®ƒ.

composition ä¸å†ä½¿ç”¨å¹¶å·²åºŸå¼ƒã€‚

## koa-router

### koa-router æ¦‚è¿°

koa-router çš„æºç åªæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼šrouter.js å’Œ layer.jsï¼Œåˆ†åˆ«å¯¹åº” Router å¯¹è±¡å’Œ Layer å¯¹è±¡ã€‚

Layer å¯¹è±¡æ˜¯å¯¹å•ä¸ªè·¯ç”±çš„ç®¡ç†ï¼Œå…¶ä¸­åŒ…å«çš„ä¿¡æ¯æœ‰è·¯ç”±è·¯å¾„(path)ã€è·¯ç”±è¯·æ±‚æ–¹æ³•(method)å’Œè·¯ç”±æ‰§è¡Œå‡½æ•°(middleware)ï¼Œå¹¶ä¸”æä¾›è·¯ç”±çš„éªŒè¯ä»¥åŠ params å‚æ•°è§£æçš„æ–¹æ³•ã€‚

ç›¸æ¯”è¾ƒ Layer å¯¹è±¡ï¼ŒRouter å¯¹è±¡åˆ™æ˜¯å¯¹æ‰€æœ‰æ³¨å†Œè·¯ç”±çš„ç»Ÿä¸€å¤„ç†ï¼Œå¹¶ä¸”å®ƒçš„ API æ˜¯é¢å‘å¼€å‘è€…çš„ã€‚

### Layer

Layer å¯¹è±¡ä¸»è¦æ˜¯å¯¹å•ä¸ªè·¯ç”±çš„ç®¡ç†ï¼Œæ˜¯æ•´ä¸ª koa-router ä¸­æœ€å°çš„å¤„ç†å•å…ƒï¼Œåç»­æ¨¡å—çš„å¤„ç†éƒ½ç¦»ä¸å¼€ Layer ä¸­çš„æ–¹æ³•

Layer æ„é€ å‡½æ•°ä¸»è¦ç”¨æ¥åˆå§‹åŒ–è·¯ç”±è·¯å¾„ã€è·¯ç”±è¯·æ±‚æ–¹æ³•æ•°ç»„ã€è·¯ç”±å¤„ç†å‡½æ•°æ•°ç»„ã€è·¯ç”±æ­£åˆ™è¡¨è¾¾å¼ä»¥åŠ params å‚æ•°ä¿¡æ¯æ•°ç»„ï¼Œå…¶ä¸­ä¸»è¦é‡‡ç”¨ path-to-regexp æ–¹æ³•æ ¹æ®è·¯å¾„å­—ç¬¦ä¸²ç”Ÿæˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œé€šè¿‡è¯¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥å®ç°è·¯ç”±çš„åŒ¹é…ä»¥åŠ params å‚æ•°çš„æ•è·

```js
function Layer(path, methods, middleware, opts) {
  this.opts = opts || {};
  // æ”¯æŒè·¯ç”±åˆ«å
  this.name = this.opts.name || null;
  this.methods = [];
  this.paramNames = [];
  // å°†è·¯ç”±æ‰§è¡Œå‡½æ•°ä¿å­˜åœ¨stackä¸­ï¼Œæ”¯æŒè¾“å…¥å¤šä¸ªå¤„ç†å‡½æ•°
  this.stack = Array.isArray(middleware) ? middleware : [middleware];

  methods.forEach(function(method) {
    var l = this.methods.push(method.toUpperCase());
    // HEADè¯·æ±‚å¤´éƒ¨ä¿¡æ¯ä¸GETä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸€èµ·å¤„ç†äº†ã€‚
    if (this.methods[l - 1] === "GET") {
      this.methods.unshift("HEAD");
    }
  }, this);

  // ç¡®ä¿ç±»å‹æ­£ç¡®
  this.stack.forEach(function(fn) {
    var type = typeof fn;
    if (type !== "function") {
      throw new Error(
        methods.toString() +
          " `" +
          (this.opts.name || path) +
          "`: `middleware` " +
          "must be a function, not `" +
          type +
          "`"
      );
    }
  }, this);

  this.path = path;
  // 1ã€æ ¹æ®è·¯ç”±è·¯å¾„ç”Ÿæˆè·¯ç”±æ­£åˆ™è¡¨è¾¾å¼
  // 2ã€å°†paramså‚æ•°ä¿¡æ¯ä¿å­˜åœ¨paramNamesæ•°ç»„ä¸­
  this.regexp = pathToRegExp(path, this.paramNames, this.opts);
}

// éªŒè¯è·¯ç”±
Layer.prototype.match = function(path) {
  return this.regexp.test(path);
};

// æ•è·paramså‚æ•°
Layer.prototype.captures = function(path) {
  // åç»­ä¼šæåˆ° å¯¹äºè·¯ç”±çº§åˆ«ä¸­é—´ä»¶ æ— éœ€æ•è·params
  if (this.opts.ignoreCaptures) return [];
  return path.match(this.regexp).slice(1);
};
```

æ ¹æ® paramNames ä¸­çš„å‚æ•°ä¿¡æ¯ä»¥åŠ captrues æ–¹æ³•ï¼Œå¯ä»¥è·å–åˆ°å½“å‰è·¯ç”± params å‚æ•°çš„é”®å€¼

```js
Layer.prototype.params = function(path, captures, existingParams) {
  var params = existingParams || {};
  for (var len = captures.length, i = 0; i < len; i++) {
    if (this.paramNames[i]) {
      var c = captures[i];
      params[this.paramNames[i].name] = c ? safeDecodeURIComponent(c) : c;
    }
  }
  return params;
};
```

ä¸Šè¿°ä»£ç ä¸­çš„ safeDecodeURIComponent æ–¹æ³•ï¼Œä¸ºäº†é¿å…æœåŠ¡å™¨æ”¶åˆ°ä¸å¯é¢„çŸ¥çš„è¯·æ±‚ï¼Œå¯¹äºä»»ä½•ç”¨æˆ·è¾“å…¥çš„ä½œä¸º URI éƒ¨åˆ†çš„å†…å®¹éƒ½éœ€è¦é‡‡ç”¨ encodeURIComponent è¿›è¡Œè½¬ä¹‰ï¼Œå¦åˆ™å½“ç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¸­å«æœ‰'&'ã€'='ã€'?'ç­‰å­—ç¬¦æ—¶ï¼Œä¼šå‡ºç°é¢„æ–™ä¹‹å¤–çš„æƒ…å†µã€‚è€Œå½“æˆ‘ä»¬è·å– URL ä¸Šçš„å‚æ•°æ—¶ï¼Œåˆ™éœ€è¦é€šè¿‡ decodeURIComponent è¿›è¡Œè§£ç ï¼Œè€Œ decodeURIComponent åªèƒ½è§£ç ç”± encodeURIComponent æ–¹æ³•æˆ–è€…ç±»ä¼¼æ–¹æ³•ç¼–ç ï¼Œå¦‚æœç¼–ç æ–¹æ³•ä¸ç¬¦åˆè¦æ±‚ï¼ŒdecodeURIComponent åˆ™ä¼šæŠ›å‡º URIErrorï¼Œæ‰€ä»¥ä½œè€…åœ¨è¿™é‡Œå¯¹è¯¥æ–¹æ³•è¿›è¡Œäº†å®‰å…¨åŒ–çš„å¤„ç†ï¼š

```js
function safeDecodeURIComponent(text) {
  try {
    return decodeURIComponent(text);
  } catch (e) {
    return text;
  }
}
```

Layer è¿˜æä¾›äº†å¯¹äºå•ä¸ª param å‰ç½®å¤„ç†çš„æ–¹æ³•ï¼š

```js
Layer.prototype.param = function(param, fn) {
  var stack = this.stack;
  var params = this.paramNames;
  var middleware = function(ctx, next) {
    return fn.call(this, ctx.params[param], ctx, next);
  };
  middleware.param = param;
  var names = params.map(function(p) {
    return p.name;
  });
  var x = names.indexOf(param);
  if (x > -1) {
    stack.some(function(fn, i) {
      if (!fn.param || names.indexOf(fn.param) > x) {
        // å°†å•ä¸ªparamå‰ç½®å¤„ç†å‡½æ•°æ’å…¥æ­£ç¡®çš„ä½ç½®
        stack.splice(i, 0, middleware);
        return true; // è·³å‡ºå¾ªç¯
      }
    });
  }

  return this;
};
```

ä¸Šè¿°ä»£ç ä¸­é€šè¿‡ some æ–¹æ³•å¯»æ‰¾å•ä¸ª param å¤„ç†å‡½æ•°çš„åŸå› åœ¨äºä»¥ä¸‹ä¸¤ç‚¹ï¼š

- ä¿æŒ param å¤„ç†å‡½æ•°ä½äºå…¶ä»–è·¯ç”±å¤„ç†å‡½æ•°çš„å‰é¢ï¼›
- è·¯ç”±ä¸­å­˜åœ¨å¤šä¸ª param å‚æ•°ï¼Œéœ€è¦ä¿æŒ param å¤„ç†å‡½æ•°çš„å‰åé¡ºåºã€‚

Layer ä¸­çš„ setPrefix æ–¹æ³•ç”¨äºè®¾ç½®è·¯ç”±è·¯å¾„çš„å‰ç¼€ï¼Œè¿™åœ¨åµŒå¥—è·¯ç”±çš„å®ç°ä¸­å°¤å…¶é‡è¦

```js
Layer.prototype.setPrefix = function(prefix) {
  if (this.path) {
    this.path = prefix + this.path;
    this.paramNames = [];
    this.regexp = pathToRegExp(this.path, this.paramNames, this.opts);
  }

  return this;
};
```

æœ€åï¼ŒLayer è¿˜æä¾›äº†æ ¹æ®è·¯ç”±ç”Ÿæˆ url çš„æ–¹æ³•ï¼Œä¸»è¦é‡‡ç”¨ path-to-regexp çš„ compile å’Œ parse å¯¹è·¯ç”±è·¯å¾„ä¸­çš„ param è¿›è¡Œæ›¿æ¢ï¼Œè€Œåœ¨æ‹¼æ¥ query çš„ç¯èŠ‚ï¼Œæ­£å¦‚å‰é¢æ‰€è¯´éœ€è¦å¯¹é”®å€¼å¯¹è¿›è¡Œç¹ççš„ encodeURIComponent æ“ä½œï¼Œä½œè€…é‡‡ç”¨äº† urijs æä¾›çš„ç®€æ´ api è¿›è¡Œå¤„ç†

### è·¯ç”±æ³¨å†Œ

é¦–å…ˆçœ‹äº†è§£ä¸€ä¸‹ Router æ„é€ å‡½æ•°

```js
function Router(opts) {
  if (!(this instanceof Router)) {
    // é™åˆ¶å¿…é¡»é‡‡ç”¨newå…³é”®å­—
    return new Router(opts);
  }

  this.opts = opts || {};
  // æœåŠ¡å™¨æ”¯æŒçš„è¯·æ±‚æ–¹æ³•ï¼Œ åç»­allowedMethodsæ–¹æ³•ä¼šç”¨åˆ°
  this.methods = this.opts.methods || [
    "HEAD",
    "OPTIONS",
    "GET",
    "PUT",
    "PATCH",
    "POST",
    "DELETE",
  ];

  this.params = {}; // ä¿å­˜paramå‰ç½®å¤„ç†å‡½æ•°
  this.stack = []; // å­˜å‚¨layer
}
```

åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„ params å’Œ stack å±æ€§æœ€ä¸ºé‡è¦ï¼Œå‰è€…ç”¨æ¥ä¿å­˜ param å‰ç½®å¤„ç†å‡½æ•°ï¼Œåè€…ç”¨æ¥ä¿å­˜å®ä¾‹åŒ–çš„ Layer å¯¹è±¡

koa-router ä¸­æä¾›ä¸¤ç§æ–¹å¼æ³¨å†Œè·¯ç”±ï¼š

- å…·ä½“çš„ HTTP åŠ¨è¯æ³¨å†Œæ–¹å¼ï¼Œä¾‹å¦‚ï¼šrouter.get('/users', ctx => {})
- æ”¯æŒæ‰€æœ‰çš„ HTTP åŠ¨è¯æ³¨å†Œæ–¹å¼ï¼Œä¾‹å¦‚ï¼šrouter.all('/users', ctx => {})

æºç ä¸­é‡‡ç”¨ methods æ¨¡å—è·å– HTTP è¯·æ±‚æ–¹æ³•åï¼Œè¯¥æ¨¡å—å†…éƒ¨å®ç°ä¸»è¦ä¾èµ–äº http æ¨¡å—

```js
http.METHODS &&
  http.METHODS.map(function lowerCaseMethod(method) {
    return method.toLowerCase();
  });
```

`router.verb()`å’Œ `router.all()` è¿™ä¸¤ç§æ³¨å†Œè·¯ç”±çš„æ–¹å¼çš„å†…éƒ¨å®ç°åŸºæœ¬ç±»ä¼¼

```js
methods.forEach(function(method) {
  Router.prototype[method] = function(name, path, middleware) {
    var middleware;

    // 1ã€å¤„ç†æ˜¯å¦ä¼ å…¥nameå‚æ•°
    // 2ã€middlewareå‚æ•°æ”¯æŒmiddleware1, middleware2...çš„å½¢å¼
    if (typeof path === "string" || path instanceof RegExp) {
      middleware = Array.prototype.slice.call(arguments, 2);
    } else {
      middleware = Array.prototype.slice.call(arguments, 1);
      path = name;
      name = null;
    }

    // è·¯ç”±æ³¨å†Œçš„æ ¸å¿ƒå¤„ç†é€»è¾‘
    this.register(path, [method], middleware, {
      name: name,
    });

    return this;
  };
});
```

è¯¥æ–¹æ³•ç¬¬ä¸€éƒ¨åˆ†æ˜¯å¯¹ä¼ å…¥å‚æ•°çš„å¤„ç†

ç¬¬äºŒéƒ¨åˆ†æ˜¯ register æ–¹æ³•ï¼Œä¼ å…¥çš„ method å‚æ•°çš„å½¢å¼å°±æ˜¯ router.verb()ä¸ router.all()çš„æœ€å¤§åŒºåˆ«ï¼Œåœ¨ router.verb()ä¸­ä¼ å…¥çš„ method æ˜¯å•ä¸ªæ–¹æ³•ï¼Œåè€…åˆ™æ˜¯ä»¥æ•°ç»„çš„å½¢å¼ä¼ å…¥ HTTP æ‰€æœ‰çš„è¯·æ±‚æ–¹æ³•ï¼Œæ‰€ä»¥å¯¹äºè¿™ä¸¤ç§æ³¨å†Œæ–¹æ³•çš„å®ç°ï¼Œæœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„

register æ–¹æ³•ä¸»è¦è´Ÿè´£å®ä¾‹åŒ– Layer å¯¹è±¡ã€æ›´æ–°è·¯ç”±å‰ç¼€å’Œå‰ç½® param å¤„ç†å‡½æ•°

use æ˜¯ç”¨æ¥æ³¨å†Œä¸­é—´ä»¶çš„æ–¹æ³•ï¼Œç›¸æ¯”è¾ƒ Koa ä¸­çš„å…¨å±€ä¸­é—´ä»¶ï¼Œkoa-router çš„ä¸­é—´ä»¶åˆ™æ˜¯è·¯ç”±çº§åˆ«çš„

```js
Router.prototype.use = function() {
  var router = this;
  var middleware = Array.prototype.slice.call(arguments);
  var path;

  // æ”¯æŒå¤šè·¯å¾„åœ¨äºä¸­é—´ä»¶å¯èƒ½ä½œç”¨äºå¤šæ¡è·¯ç”±è·¯å¾„
  if (Array.isArray(middleware[0]) && typeof middleware[0][0] === "string") {
    middleware[0].forEach(function(p) {
      router.use.apply(router, [p].concat(middleware.slice(1)));
    });

    return this;
  }
  // å¤„ç†è·¯ç”±è·¯å¾„å‚æ•°
  var hasPath = typeof middleware[0] === "string";
  if (hasPath) {
    path = middleware.shift();
  }

  middleware.forEach(function(m) {
    // åµŒå¥—è·¯ç”±
    if (m.router) {
      // åµŒå¥—è·¯ç”±æ‰å¹³åŒ–å¤„ç†
      m.router.stack.forEach(function(nestedLayer) {
        // æ›´æ–°åµŒå¥—ä¹‹åçš„è·¯ç”±è·¯å¾„
        if (path) nestedLayer.setPrefix(path);
        // æ›´æ–°æŒ‚è½½åˆ°çˆ¶è·¯ç”±ä¸Šçš„è·¯ç”±è·¯å¾„
        if (router.opts.prefix) nestedLayer.setPrefix(router.opts.prefix);

        router.stack.push(nestedLayer);
      });

      // ä¸è¦å¿˜è®°å°†çˆ¶è·¯ç”±ä¸Šçš„paramå‰ç½®å¤„ç†æ“ä½œ æ›´æ–°åˆ°æ–°è·¯ç”±ä¸Šã€‚
      if (router.params) {
        Object.keys(router.params).forEach(function(key) {
          m.router.param(key, router.params[key]);
        });
      }
    } else {
      // è·¯ç”±çº§åˆ«ä¸­é—´ä»¶ åˆ›å»ºä¸€ä¸ªæ²¡æœ‰methodçš„Layerå®ä¾‹
      router.register(path || "(.*)", [], m, {
        end: false,
        ignoreCaptures: !hasPath,
      });
    }
  });

  return this;
};
```

koa-router ä¸­é—´ä»¶æ³¨å†Œæ–¹æ³•ä¸»è¦å®Œæˆä¸¤é¡¹åŠŸèƒ½ï¼š

- å°†è·¯ç”±åµŒå¥—ç»“æ„æ‰å¹³åŒ–ï¼Œå…¶ä¸­æ¶‰åŠåˆ°è·¯ç”±è·¯å¾„çš„æ›´æ–°å’Œ param å‰ç½®å¤„ç†å‡½æ•°çš„æ’å…¥ï¼›
- è·¯ç”±çº§åˆ«ä¸­é—´ä»¶é€šè¿‡æ³¨å†Œä¸€ä¸ªæ²¡æœ‰ method çš„ Layer å®ä¾‹è¿›è¡Œç®¡ç†ã€‚

### è·¯ç”±åŒ¹é…

```js
Router.prototype.match = function(path, method) {
  var layers = this.stack;
  var layer;
  var matched = {
    path: [],
    pathAndMethod: [],
    route: false,
  };

  for (var len = layers.length, i = 0; i < len; i++) {
    layer = layers[i];
    if (layer.match(path)) {
      // è·¯ç”±è·¯å¾„æ»¡è¶³è¦æ±‚
      matched.path.push(layer);

      if (layer.methods.length === 0 || ~layer.methods.indexOf(method)) {
        // layer.methods.length === 0 è¯¥layerä¸ºè·¯ç”±çº§åˆ«ä¸­é—´ä»¶
        // ~layer.methods.indexOf(method) è·¯ç”±è¯·æ±‚æ–¹æ³•ä¹Ÿè¢«åŒ¹é…
        matched.pathAndMethod.push(layer);
        // ä»…å½“è·¯ç”±è·¯å¾„å’Œè·¯ç”±è¯·æ±‚æ–¹æ³•éƒ½è¢«æ»¡è¶³æ‰ç®—æ˜¯è·¯ç”±è¢«åŒ¹é…
        if (layer.methods.length) matched.route = true;
      }
    }
  }
  return matched;
};
```

match æ–¹æ³•ä¸»è¦é€šè¿‡`layer.match`æ–¹æ³•ä»¥åŠ methods å±æ€§å¯¹ layer è¿›è¡Œç­›é€‰ï¼Œè¿”å›çš„ matched å¯¹è±¡åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

- path: ä¿å­˜æ‰€æœ‰è·¯ç”±è·¯å¾„è¢«åŒ¹é…çš„ layerï¼›
- pathAndMethod: åœ¨è·¯ç”±è·¯å¾„è¢«åŒ¹é…çš„å‰æä¸‹ï¼Œä¿å­˜è·¯ç”±çº§åˆ«ä¸­é—´ä»¶å’Œè·¯ç”±è¯·æ±‚æ–¹æ³•è¢«åŒ¹é…çš„ layerï¼›
- route: ä»…å½“å­˜åœ¨è·¯ç”±è·¯å¾„å’Œè·¯ç”±è¯·æ±‚æ–¹æ³•éƒ½è¢«åŒ¹é…çš„ layerï¼Œæ‰èƒ½ç®—æ˜¯æœ¬æ¬¡è·¯ç”±è¢«åŒ¹é…ä¸Šã€‚

### è·¯ç”±æ‰§è¡Œæµç¨‹

koa ä¸­æ³¨å†Œ koa-router ä¸­é—´ä»¶çš„æ–¹å¼å¦‚ä¸‹

```js
const Koa = require("koa");
const Router = require("koa-router");

const app = new Koa();
const router = new Router();

router.get("/", (ctx, next) => {
  // ctx.router available
});

app.use(router.routes()).use(router.allowedMethods());
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡º koa-router æä¾›äº†ä¸¤ä¸ªä¸­é—´ä»¶æ–¹æ³•ï¼šroutes å’Œ allowedMethods

allowedMethods()ä¸­é—´ä»¶ä¸»è¦ç”¨äºå¤„ç† options è¯·æ±‚ï¼Œå“åº” 405 å’Œ 501 çŠ¶æ€

routes()ä¸­é—´ä»¶ä¸»è¦å®ç°äº†å››å¤§åŠŸèƒ½ã€‚

- å°† matched å¯¹è±¡çš„ path å±æ€§æŒ‚è½½åœ¨ ctx.matched ä¸Šï¼Œæä¾›ç»™åç»­çš„ allowedMethods ä¸­é—´ä»¶ä½¿ç”¨ã€‚
- å°†è¿”å›çš„ dispatch å‡½æ•°è®¾ç½® router å±æ€§ï¼Œä»¥ä¾¿åœ¨å‰é¢æåˆ°çš„ Router.prototype.use æ–¹æ³•ä¸­åŒºåˆ«è·¯ç”±çº§åˆ«ä¸­é—´ä»¶å’ŒåµŒå¥—è·¯ç”±ã€‚
- æ’å…¥ä¸€ä¸ªæ–°çš„è·¯ç”±å‰ç½®å¤„ç†ä¸­é—´ä»¶ï¼Œå°† layer è§£æå‡ºæ¥çš„ params å¯¹è±¡ã€è·¯ç”±åˆ«åä»¥åŠæ•è·æ•°ç»„æŒ‚è½½åœ¨ ctx ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™ç§æ“ä½œåŒç† Koa åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰å…ˆæ„å»º context å¯¹è±¡
- è€Œå¯¹äºè·¯ç”±åŒ¹é…åˆ°ä¼—å¤š layerï¼Œkoa-router é€šè¿‡ koa-compose è¿›è¡Œå¤„ç†ï¼Œè¿™å’Œ koa å¯¹äºä¸­é—´ä»¶å¤„ç†çš„æ–¹å¼ä¸€æ ·çš„ï¼Œæ‰€ä»¥ koa-router å®Œå…¨å°±æ˜¯ä¸€ä¸ªå°å‹æ´‹è‘±æ¨¡å‹

```js
Router.prototype.routes = Router.prototype.middleware = function() {
  var router = this;
  // è¿”å›ä¸­é—´ä»¶å¤„ç†å‡½æ•°
  var dispatch = function dispatch(ctx, next) {
    var path = router.opts.routerPath || ctx.routerPath || ctx.path;
    var matched = router.match(path, ctx.method);
    var layerChain, layer, i;

    // ã€1ã€‘ä¸ºåç»­çš„allowedMethodsä¸­é—´ä»¶å‡†å¤‡
    if (ctx.matched) {
      ctx.matched.push.apply(ctx.matched, matched.path);
    } else {
      ctx.matched = matched.path;
    }

    ctx.router = router;

    // æœªåŒ¹é…è·¯ç”± ç›´æ¥è·³è¿‡
    if (!matched.route) return next();

    var matchedLayers = matched.pathAndMethod;
    var mostSpecificLayer = matchedLayers[matchedLayers.length - 1];
    ctx._matchedRoute = mostSpecificLayer.path;
    if (mostSpecificLayer.name) {
      ctx._matchedRouteName = mostSpecificLayer.name;
    }
    layerChain = matchedLayers.reduce(function(memo, layer) {
      // ã€3ã€‘è·¯ç”±çš„å‰ç½®å¤„ç†ä¸­é—´ä»¶ ä¸»è¦è´Ÿè´£å°†paramsã€è·¯ç”±åˆ«åä»¥åŠæ•è·æ•°ç»„å±æ€§æŒ‚è½½åœ¨ctxä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ã€‚
      memo.push(function(ctx, next) {
        ctx.captures = layer.captures(path, ctx.captures);
        ctx.params = layer.params(path, ctx.captures, ctx.params);
        ctx.routerName = layer.name;
        return next();
      });
      return memo.concat(layer.stack);
    }, []);
    // ã€4ã€‘åˆ©ç”¨koaä¸­é—´ä»¶ç»„ç»‡çš„æ–¹å¼ï¼Œå½¢æˆä¸€ä¸ªâ€˜å°æ´‹è‘±â€™æ¨¡å‹
    return compose(layerChain)(ctx, next);
  };

  // ã€2ã€‘routerå±æ€§ç”¨æ¥useæ–¹æ³•ä¸­åŒºåˆ«è·¯ç”±çº§åˆ«ä¸­é—´ä»¶
  dispatch.router = this;
  return dispatch;
};
```

::: tip
koa-router è™½ç„¶æ˜¯ koa çš„ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä½†æ˜¯å…¶å†…éƒ¨ä¹ŸåŒ…å«ä¼—å¤šçš„ä¸­é—´ä»¶ï¼Œè¿™äº›ä¸­é—´ä»¶é€šè¿‡ Layer å¯¹è±¡æ ¹æ®è·¯ç”±è·¯å¾„çš„ä¸åŒè¿›è¡Œåˆ’åˆ†ï¼Œä½¿å¾—å®ƒä»¬ä¸å†åƒ koa çš„ä¸­é—´ä»¶é‚£æ ·æ¯æ¬¡è¯·æ±‚éƒ½æ‰§è¡Œï¼Œè€Œæ˜¯é’ˆå¯¹æ¯æ¬¡è¯·æ±‚é‡‡ç”¨ match æ–¹æ³•åŒ¹é…å‡ºç›¸åº”çš„ä¸­é—´ä»¶ï¼Œå†åˆ©ç”¨ koa-compose å½¢æˆä¸€ä¸ªä¸­é—´ä»¶æ‰§è¡Œé“¾
:::
