---
time: 2021-03-06
icon: template
category: é¢è¯•
article: false
sidebar: auto
footer: ğŸ˜ğŸ˜ğŸ˜
tag:
  - å‰ç«¯
  - React
---

# Front-end interview-component communication in React

## å•é¡¹æ•°æ®æµ

React çš„æ ¸å¿ƒç‰¹å¾æ˜¯â€œæ•°æ®é©±åŠ¨è§†å›¾â€ï¼Œè¿™ä¸ªç‰¹å¾åœ¨ä¸šå†…æœ‰ä¸€ä¸ªéå¸¸æœ‰åçš„å‡½æ•°å¼æ¥è¡¨è¾¾

```
UI = render(data)
UI = f(data)
```

ç»„ä»¶ï¼Œä»æ¦‚å¿µä¸Šç±»ä¼¼äº JavaScript å‡½æ•°ï¼Œä»–æ¥å—ä»»æ„ç±»å‹çš„å…¥å‚ï¼ˆå³ propsï¼‰å¹¶è¿”å›ç”¨äºæè¿°é¡µé¢å†…å®¹çš„ React å…ƒç´ 

æ—¢ç„¶ props æ˜¯ç»„ä»¶çš„å…¥å‚ï¼Œé‚£ä¹ˆç»„ä»¶ä¹‹é—´é€šè¿‡ä¿®æ”¹å¯¹æ–¹çš„å…¥å‚æ¥å®Œæˆæ•°æ®é€šä¿¡å°±æ˜¯å¤©ç»åœ°ä¹‰çš„äº‹æƒ…äº†ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªâ€œä¿®æ”¹â€ä¹Ÿæ˜¯æœ‰åŸåˆ™çš„â€”â€”ä½ å¿…é¡»ç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½åœ¨â€œå•å‘æ•°æ®æµâ€è¿™ä¸ªå‰æä¸‹

æ‰€è°“å•å‘æ•°æ®æµï¼ŒæŒ‡çš„å°±æ˜¯å½“å‰ç»„ä»¶çš„ state ä»¥ props çš„å½¢å¼æµåŠ¨æ—¶ï¼Œåªèƒ½æµå‘ç»„ä»¶æ ‘ä¸­æ¯”è‡ªå·±å±‚çº§æ›´ä½çš„ç»„ä»¶ã€‚ æ¯”å¦‚åœ¨çˆ¶-å­ç»„ä»¶è¿™ç§åµŒå¥—å…³ç³»ä¸­ï¼Œåªèƒ½ç”±çˆ¶ç»„ä»¶ä¼  props ç»™å­ç»„ä»¶ï¼Œè€Œä¸èƒ½åè¿‡æ¥ã€‚

å¬ä¸Šå»è™½ç„¶é™åˆ¶é‡é‡ï¼Œä½†ç”¨èµ·æ¥å´æ˜¯ç›¸å½“çš„çµæ´»ã€‚åŸºäº props ä¼ å‚è¿™ç§å½¢å¼ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°çˆ¶-å­é€šä¿¡ã€å­-çˆ¶é€šä¿¡å’Œå…„å¼Ÿç»„ä»¶é€šä¿¡

## çˆ¶å­ä¹‹é—´çš„é€šä¿¡

**çˆ¶å‘å­**

çˆ¶ä¸å­çš„é€šä¿¡æ˜¯æœ€å¸¸è§çš„åœºæ™¯ï¼ŒReact å¼€å‘çš„æ¯ä¸ªç»„ä»¶éƒ½åœ¨ä½¿ç”¨è¿™æ ·çš„è®¾è®¡æ¨¡å¼ã€‚æ¯ä¸ªç»„ä»¶éƒ½ä¼šåœ¨çˆ¶çº§è¢«ä½¿ç”¨ï¼Œå†ä¼ å…¥ Propsï¼Œå®Œæˆä¿¡æ¯çš„ä¼ é€’ã€‚è¿™æ ·çš„äº¤äº’æ–¹å¼å°½ç®¡ä¸èµ·çœ¼ï¼Œå®¹æ˜“è®©äººå¿½ç•¥ï¼Œä½†æ­£æ˜¯æœ€ç»å…¸çš„è®¾è®¡

```js
const Button = ({ text }) => {
    <button type="button">{text}</button>
}
class HomePage extends React.Component {
   state = {
      text: "é»˜è®¤æ–‡æ¡ˆ"
   }

   asyc componentDidMount() {
     const response = await fetch('/api/buttonText')
     this.setState({
       text: response.buttoText
     })
   }

    render() {
        const {
          text
        } = this.state
        return (
            <Button text={text} />
        )
    }
}
```

**å­å‘çˆ¶**

å›è°ƒå‡½æ•°åœ¨ JavaScript ä¸­ç§°ä¸º callbackã€‚React åœ¨è®¾è®¡ä¸­æ²¿ç”¨äº† JavaScript çš„ç»å…¸è®¾è®¡ï¼Œå…è®¸å‡½æ•°ä½œä¸ºå‚æ•°èµ‹å€¼ç»™å­ç»„ä»¶ã€‚æœ€åŸºç¡€çš„ç”¨æ³•å°±åƒä¸‹é¢çš„ä¾‹å­ä¸€æ ·ï¼Œé€šè¿‡åŒ…è£…ä¼ é€’ text çš„å€¼

```js
class Input extends React.Component {
  handleChanged = (e) => {
    this.onChangeText(e.target.text);
  };

  render() {
    return <input onChange={handleTextChanged} />;
  }
}
class HomePage extends React.Component {
  handleTextChanged = (text) => {
    console.log(text);
  };

  render() {
    return <Input onChangeText={this.handleTextChanged} />;
  }
}
```

å›è°ƒå‡½æ•°ä¸ä»…ä»…ç”¨äºä¼ é€’å€¼ï¼Œå®ƒè¿˜å¯ä»¥ç”¨åœ¨æ¸²æŸ“ä¸­ï¼Œçˆ¶ç»„ä»¶æ ¹æ®è¿”å›çš„ç»“æœï¼Œå†³å®šå­ç»„ä»¶è¯¥æ¸²æŸ“ä»€ä¹ˆã€‚æ¯”å¦‚åœ¨ React Router ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šè¿™æ ·ä½¿ç”¨å®ƒ

```js
<Route path="/hello" render={() => <h1>Hello Everyone</h1>} />
```

è¿™é‡Œçš„å›è°ƒå‡½æ•°æ²¡ç”¨å…·ä½“çš„å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹æ¥ä¸‹æ¥çš„æ¡ˆä¾‹ï¼š

```js
class FetchPosts extends React.Component {
  state = {
    loading: true,
    data: [],
  };

  async componentDidMount() {
    const response = await fetch("/api/posts");
    this.setState({
      data: response.data,
      loading: false,
    });
  }
  render() {
    if (this.state.loading) {
      return <Loading />;
    }
    return this.props.renderPosts(this.state.data);
  }
}
class HomePage extends React.Component {
  render() {
    return (
      <FetchPosts
        renderPosts={(posts) => (
          <ul>
            {posts.map((post) => (
              <li key={post.id}>
                <h2>{post.title}</h2>
                <p>{post.description}</p>
              </li>
            ))}
          </ul>
        )}
      />
    );
  }
}
```

## å…„å¼Ÿä¹‹é—´çš„é€šä¿¡

å…„å¼Ÿç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼Œå¾€å¾€ä¾èµ–å…±åŒçš„çˆ¶ç»„ä»¶è¿›è¡Œä¸­è½¬

```js
class Input extends React.Component {
  handleChanged = (e) => {
    this.onChangeText(e.target.text);
  };

  render() {
    return <input onChange={handleTextChanged} />;
  }
}
const StaticText = ({ children }) => {
  return <P>{children}</p>;
};
class HomePage extends React.Component {
  state = {
    text: "é»˜è®¤æ–‡æ¡ˆ",
  };
  handleTextChanged = (text) => {
    this.setState({
      text,
    });
  };

  render() {
    return (
      <>
        <Input onChangeText={this.handleTextChanged} />
        <StaticText>this.state.text</StaticText>
      </>
    );
  }
}
```

StaticText ç»„ä»¶éœ€è¦æ˜¾ç¤ºçš„å†…å®¹æ¥è‡ªè¾“å…¥æ¡†è¾“å…¥çš„å€¼ï¼Œé‚£ä¹ˆé€šè¿‡çˆ¶ç»„ä»¶çš„ state è¿›è¡Œæ”¶é›†ã€ä¸­è½¬ã€èµ‹å€¼ç»™ StaticTextï¼Œå°±å®Œæˆäº†ä»¥ä¸Šçš„é€šä¿¡ã€‚

è¿™ç§æ¨¡å¼ä¸»è¦è´Ÿè´£åœ¨å®¹å™¨ç»„ä»¶ä¸­åè°ƒå„ç»„ä»¶

::: tip ä¸æ¨èç”¨ props è§£å†³å…¶ä»–åœºæ™¯çš„éœ€æ±‚
è‡³æ­¤ï¼Œæˆ‘ä»¬ç»™å‡ºäº† props ä¼ å‚è¿™ç§å½¢å¼æ¯”è¾ƒé€‚åˆå¤„ç†çš„ä¸‰ç§åœºæ™¯ã€‚å°½ç®¡è¿™å¹¶ä¸æ„å‘³ç€å…¶ä»–åœºæ™¯ä¸èƒ½ç”¨ props å¤„ç†ï¼Œä½†å¦‚æœä½ è¯•å›¾ç”¨ç®€å•çš„ props ä¼ é€’å®Œæˆæ›´åŠ å¤æ‚çš„é€šä¿¡éœ€æ±‚ï¼Œå¾€å¾€ä¼šå¾—ä¸å¿å¤±

![](https://s0.lgstatic.com/i/image/M00/60/F8/Ciqc1F-Om5iAAUUhAABLimeJTao712.png)

å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤šå±‚åµŒå¥—ç»„ä»¶ç»“æ„ã€‚A ç»„ä»¶å€˜è‹¥æƒ³è¦å’Œå±‚å±‚ç›¸éš”çš„ E ç»„ä»¶å®ç°é€šä¿¡ï¼Œå°±å¿…é¡»æŠŠ props ç»è¿‡ Bã€Cã€D ä¸€å±‚ä¸€å±‚åœ°ä¼ é€’ä¸‹å»ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œååå¤å¤çš„ props ä¼ é€’ä¸ä»…ä¼šå¸¦æ¥åºå¤§çš„å·¥ä½œé‡å’Œä»£ç é‡ï¼Œè¿˜ä¼šæ±¡æŸ“ä¸­é—´æ— è¾œçš„ Bã€Cã€D ç»„ä»¶çš„å±æ€§ç»“æ„ã€‚

å±‚å±‚ä¼ é€’çš„ä¼˜ç‚¹æ˜¯éå¸¸ç®€å•ï¼Œç”¨å·²æœ‰çŸ¥è¯†å°±èƒ½è§£å†³ï¼Œä½†é—®é¢˜æ˜¯ä¼šæµªè´¹å¾ˆå¤šä»£ç ï¼Œéå¸¸çƒ¦çï¼Œä¸­é—´ä½œä¸ºæ¡¥æ¢çš„ç»„ä»¶ä¼šå¼•å…¥å¾ˆå¤šä¸å±äºè‡ªå·±çš„å±æ€§ã€‚çŸ­æœŸæ¥çœ‹ï¼Œå†™ä»£ç çš„äººä¼šå¾ˆç—›è‹¦ï¼›é•¿æœŸæ¥çœ‹ï¼Œæ•´ä¸ªé¡¹ç›®çš„ç»´æŠ¤æˆæœ¬éƒ½ä¼šå˜å¾—éå¸¸é«˜æ˜‚ã€‚å› æ­¤ï¼Œå±‚å±‚ä¼ é€’ props è¦ä¸å¾—
:::

## æ— å…³ç³»çš„ç»„ä»¶é€šä¿¡

### å‘å¸ƒè®¢é˜…æ¨¡å¼

å®ç°ä¸€ä¸ª ç®€å•çš„ EventEmitter

```js
class myEventEmitter {
  constructor() {
    // eventMap ç”¨æ¥å­˜å‚¨äº‹ä»¶å’Œç›‘å¬å‡½æ•°ä¹‹é—´çš„å…³ç³»
    this.eventMap = {};
  }
  // type è¿™é‡Œå°±ä»£è¡¨äº‹ä»¶çš„åç§°
  on(type, handler) {
    // hanlder å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœä¸æ˜¯ç›´æ¥æŠ¥é”™
    if (!(handler instanceof Function)) {
      throw new Error("å“¥ ä½ é”™äº† è¯·ä¼ ä¸€ä¸ªå‡½æ•°");
    }
    // åˆ¤æ–­ type äº‹ä»¶å¯¹åº”çš„é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨
    if (!this.eventMap[type]) {
      // è‹¥ä¸å­˜åœ¨ï¼Œæ–°å»ºè¯¥é˜Ÿåˆ—
      this.eventMap[type] = [];
    }
    // è‹¥å­˜åœ¨ï¼Œç›´æ¥å¾€é˜Ÿåˆ—é‡Œæ¨å…¥ handler
    this.eventMap[type].push(handler);
  }
  // åˆ«å¿˜äº†æˆ‘ä»¬å‰é¢è¯´è¿‡è§¦å‘æ—¶æ˜¯å¯ä»¥æºå¸¦æ•°æ®çš„ï¼Œparams å°±æ˜¯æ•°æ®çš„è½½ä½“
  emit(type, params) {
    // å‡è®¾è¯¥äº‹ä»¶æ˜¯æœ‰è®¢é˜…çš„ï¼ˆå¯¹åº”çš„äº‹ä»¶é˜Ÿåˆ—å­˜åœ¨ï¼‰
    if (this.eventMap[type]) {
      // å°†äº‹ä»¶é˜Ÿåˆ—é‡Œçš„ handler ä¾æ¬¡æ‰§è¡Œå‡ºé˜Ÿ
      this.eventMap[type].forEach((handler, index) => {
        // æ³¨æ„åˆ«å¿˜äº†è¯»å– params
        handler(params);
      });
    }
  }
  off(type, handler) {
    if (this.eventMap[type]) {
      this.eventMap[type].splice(this.eventMap[type].indexOf(handler) >>> 0, 1);
    }
  }
}
```

å¯¹äºä»»æ„çš„ä¸¤ä¸ªç»„ä»¶ A å’Œ Bï¼Œå‡å¦‚æˆ‘å¸Œæœ›å®ç°åŒæ–¹ä¹‹é—´çš„é€šä¿¡ï¼Œå€ŸåŠ© EventEmitter æ¥åšå°±å¾ˆç®€å•äº†ï¼Œä»¥æ•°æ®ä» A æµå‘ B ä¸ºä¾‹

åœ¨ B ä¸­ç¼–å†™ä¸€ä¸ª handlerï¼ˆè®°å¾—å°†è¿™ä¸ª handler çš„ this ç»‘åˆ° B èº«ä¸Šï¼‰ï¼Œåœ¨è¿™ä¸ª handler ä¸­è¿›è¡Œä»¥ B ä¸ºä¸Šä¸‹æ–‡çš„ this.setState æ“ä½œï¼Œç„¶åå°†è¿™ä¸ª handler ä½œä¸ºç›‘å¬å™¨ä¸æŸä¸ªäº‹ä»¶å…³è”èµ·æ¥

```js
const globalEvent = window.myEvent;
class B extends React.Component {
  // è¿™é‡Œçœç•¥æ‰å…¶ä»–ä¸šåŠ¡é€»è¾‘
  state = {
    newParams: "",
  };
  handler = (params) => {
    this.setState({
      newParams: params,
    });
  };
  bindHandler = () => {
    globalEvent.on("someEvent", this.handler);
  };
  render() {
    return (
      <div>
        <button onClick={this.bindHandler}>ç‚¹æˆ‘ç›‘å¬Açš„åŠ¨ä½œ</button>
        <div>Aä¼ å…¥çš„å†…å®¹æ˜¯[{this.state.newParams}]</div>
      </div>
    );
  }
}
```

æ¥ä¸‹æ¥åœ¨ A ç»„ä»¶ä¸­ï¼Œåªéœ€è¦ç›´æ¥è§¦å‘å¯¹åº”çš„äº‹ä»¶ï¼Œç„¶åå°†å¸Œæœ›æºå¸¦ç»™ B çš„æ•°æ®ä½œä¸ºå…¥å‚ä¼ é€’ç»™ emit æ–¹æ³•å³

```js
class A extends React.Component {
  // è¿™é‡Œçœç•¥æ‰å…¶ä»–ä¸šåŠ¡é€»è¾‘
  state = {
    infoToB: "å“ˆå“ˆå“ˆå“ˆæˆ‘æ¥è‡ªA",
  };
  reportToB = () => {
    // è¿™é‡Œçš„ infoToB è¡¨ç¤º A è‡ªèº«çŠ¶æ€ä¸­éœ€è¦è®© B æ„ŸçŸ¥çš„é‚£éƒ¨åˆ†æ•°æ®
    globalEvent.emit("someEvent", this.state.infoToB);
  };
  render() {
    return <button onClick={this.reportToB}>ç‚¹æˆ‘æŠŠstateä¼ é€’ç»™B</button>;
  }
}
```

å¦‚æ­¤ä¸€æ¥ï¼Œä¾¿èƒ½å¤Ÿå®ç° A åˆ° B çš„é€šä¿¡äº†

### Context API

> åœ¨ React 16.3 ä¹‹å‰ï¼ŒContext API ç”±äºå­˜åœ¨ç§ç§å±€é™æ€§ï¼Œå¹¶ä¸è¢« React å®˜æ–¹æå€¡ä½¿ç”¨ï¼Œå¼€å‘è€…æ›´å¤šçš„æ˜¯æŠŠå®ƒä½œä¸ºä¸€ä¸ªæ¦‚å¿µæ¥æ¢è®¨ã€‚è€Œä» v 16.3.0 å¼€å§‹ï¼ŒReact å¯¹ Context API è¿›è¡Œäº†æ”¹è¿›ï¼Œæ–°çš„ Context API å…·å¤‡æ›´å¼ºçš„å¯ç”¨æ€§

æˆ‘ä»¬é€šè¿‡è°ƒç”¨ React.createContextï¼Œå¯ä»¥åˆ›å»ºå‡ºä¸€ç»„ Providerã€‚Provider ä½œä¸ºæ•°æ®çš„æä¾›æ–¹ï¼Œå¯ä»¥å°†æ•°æ®ä¸‹å‘ç»™è‡ªèº«ç»„ä»¶æ ‘ä¸­ä»»æ„å±‚çº§çš„ Consumerï¼Œè¿™ä¸‰è€…ä¹‹é—´çš„å…³ç³»ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤º

![](https://s0.lgstatic.com/i/image/M00/62/97/CgqCHl-Sm7iAQ6ZRAAEW2Me7WVg371.png)

Cosumer ä¸ä»…èƒ½å¤Ÿè¯»å–åˆ° Provider ä¸‹å‘çš„æ•°æ®ï¼Œè¿˜èƒ½è¯»å–åˆ°è¿™äº›æ•°æ®åç»­çš„æ›´æ–°ã€‚è¿™æ„å‘³ç€æ•°æ®åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´èƒ½å¤ŸåŠæ—¶åŒæ­¥ï¼Œè¿™å¯¹ Context è¿™ç§æ¨¡å¼æ¥è¯´è‡³å…³é‡è¦

::: tip ä½¿ç”¨æ­¥éª¤

1. React.createContextï¼Œä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ª context å¯¹è±¡ã€‚

```js
const AppContext = React.createContext();
```

åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ€§åœ°ä¼ å…¥ä¸€ä¸ª defaultValue

```js
const AppContext = React.createContext(defaultValue);
```

ä»åˆ›å»ºå‡ºçš„ context å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å–åˆ° Provider å’Œ Consumer

```js
const { Provider, Consumer } = AppContext;
```

2. Providerï¼Œå¯ä»¥ç†è§£ä¸ºâ€œæ•°æ®çš„ Providerï¼ˆæä¾›è€…ï¼‰â€

ä½¿ç”¨ Provider å¯¹ç»„ä»¶æ ‘ä¸­çš„æ ¹ç»„ä»¶è¿›è¡ŒåŒ…è£¹ï¼Œç„¶åä¼ å…¥åä¸ºâ€œvalueâ€çš„å±æ€§ï¼Œè¿™ä¸ª value å°±æ˜¯åç»­åœ¨ç»„ä»¶æ ‘ä¸­æµåŠ¨çš„â€œæ•°æ®â€ï¼Œå®ƒå¯ä»¥è¢« Consumer æ¶ˆè´¹

```js
<Provider value={title: this.state.title, content: this.state.content}>
  <Title />
  <Content />
 </Provider>
```

3. Consumerï¼Œé¡¾åæ€ä¹‰å°±æ˜¯â€œæ•°æ®çš„æ¶ˆè´¹è€…â€ï¼Œå®ƒå¯ä»¥è¯»å– Provider ä¸‹å‘ä¸‹æ¥çš„æ•°æ®

å…¶ç‰¹ç‚¹æ˜¯éœ€è¦æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå­å…ƒç´ ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ªç»„ä»¶

```js
<Consumer>{(value) => <div>{value.title}</div>}</Consumer>
```

æ³¨æ„ï¼Œå½“ Consumer æ²¡æœ‰å¯¹åº”çš„ Provider æ—¶ï¼Œvalue å‚æ•°ä¼šç›´æ¥å–åˆ›å»º context æ—¶ä¼ é€’ç»™ createContext çš„ defaultValue

:::

Context ç¬¬ä¸€ä¸ªæœ€å¸¸è§çš„ç”¨é€”å°±æ˜¯åš i18nï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å›½é™…åŒ–è¯­è¨€åŒ…

```js
import { createContext } from "react";
const I18nContext = createContext({
  translate: () => "",
  getLocale: () => {},
  setLocale: () => {},
});
export default I18nContext;
```

é¦–å…ˆä½¿ç”¨ Â React.createContextÂ  åˆ›å»º Context çš„åˆå§‹çŠ¶æ€ã€‚è¿™é‡ŒåŒ…å«ä¸‰ä¸ªå‡½æ•°ã€‚

translateï¼Œç”¨äºç¿»è¯‘æŒ‡å®šçš„é”®å€¼ã€‚

getLocaleï¼Œè·å–å½“å‰çš„è¯­è¨€åŒ…ã€‚

setLocaleï¼Œè®¾ç½®å½“å‰çš„è¯­è¨€åŒ…ã€‚

ä¸ºäº†ä»£ç ç®€æ´æ€§ï¼Œè¿™é‡ŒåŒ…è£¹äº† I18nProviderï¼Œæä¾›äº†ä¸€ä¸ªç»„ä»¶ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤º

```js
import React, { useState } from "react";
import I18nContext from "./I18nContext";
class I18nProvider extends React.Component {
  state = {
    locale: "",
  };

  render() {
    const i18n = {
      translate: (key) => this.props.languages[locale][key],
      getLocale: () => this.state.locale,
      setLocale: (locale) =>
        this.setState({
          loacal,
        }),
    };
    return (
      <I18nContext.Provider value={i18n}>
        {this.props.children}
      </I18nContext.Provider>
    );
  }
}
export default I18nProvider;
```

å¦‚æœéœ€è¦å…±äº« Context çš„æ•°æ®ï¼Œå°±éœ€è¦é’ˆå¯¹æ¯ä¸€ä¸ªç»„ä»¶åŒ…è£…ä¸€æ¬¡æ¶ˆè´¹è€…ï¼Œä¼šå¸¦æ¥å¾ˆå¤šæ— æ„ä¹‰çš„é‡å¤ä»£ç ,ä»£ç é€šè¿‡é«˜é˜¶å‡½æ•°å°è£…æ¶ˆè´¹è€…çš„é€»è¾‘æ¥å‡å°‘é‡å¤ä»£ç çš„

```js
import React from "react";
import I18nContext from "./I18nContext";
const withI18n = (wrappedComponent) => {
  return (props) => (
    <I18nContext.Consumer>
      {(i18n) => <WrappedComponent {...i18n} {...props} />}
    </I18nContext.Consumer>
  );
};
export default withI18n;
```

å‡†å¤‡å·¥ä½œå°±ç»ªä»¥åï¼Œå°±éœ€è¦åœ¨æœ€é¡¶å±‚æ³¨å…¥ Provider

```js
import React from "react";
import ReactDOM from "react-dom";
import App from "./App";
import { I18nProvider } from "./i18n";
const locales = ["en-US", "zh-CN"];
const languages = {
  "en-US": require("./locales/en-US"),
  "zh-CN": require("./locales/zh-CN"),
};
ReactDOM.render(
  <I18nProvider locales={locales} languages={languages}>
    <App />
  </I18nProvider>,
  document.getElementById("root")
);
```

æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨ Context å®ç°å›½é™…åŒ–çš„æ•ˆæœã€‚Title ç»„ä»¶ä¸­æ˜¾ç¤º title æ ‡é¢˜çš„å†…å®¹ï¼Œè€Œåœ¨ Footer ç»„ä»¶é€šè¿‡ setLocale å‡½æ•°ä¿®æ”¹å½“å‰æ˜¾ç¤ºçš„è¯­è¨€

```js
const Title = withI18n(
  ({ translate }) => {
    return ( <div>{translate('title')}</div> )
  }
)
const Footer = withI18n(
  ({ setLocale }) => {
    return ( <Button onClick=(() => {
      setLocale('zh-CN')
    }) /> )
  }
)
```

::: warning å…³äºæ–°æ—§ Context API
Cosumer ä¸ä»…èƒ½å¤Ÿè¯»å–åˆ° Provider ä¸‹å‘çš„æ•°æ®ï¼Œè¿˜èƒ½å¤Ÿè¯»å–åˆ°è¿™äº›æ•°æ®åç»­çš„æ›´æ–°â€ã€‚æ•°æ®åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„åŠæ—¶åŒæ­¥ï¼Œè¿™ä¸€ç‚¹å¯¹äº Context è¿™ç§æ¨¡å¼æ¥è¯´æ˜¯è‡³å…³é‡è¦çš„ï¼Œæ—§çš„ Conext API æ— æ³•ä¿è¯è¿™ä¸€ç‚¹

å¦‚æœç»„ä»¶æä¾›çš„ä¸€ä¸ª Context å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œä¸­é—´çˆ¶ç»„ä»¶çš„ shouldComponentUpdate è¿”å› falseï¼Œé‚£ä¹ˆä½¿ç”¨åˆ°è¯¥å€¼çš„åä»£ç»„ä»¶ä¸ä¼šè¿›è¡Œæ›´æ–°ã€‚ä½¿ç”¨äº† Context çš„ç»„ä»¶åˆ™å®Œå…¨å¤±æ§ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šæ²¡æœ‰åŠæ³•èƒ½å¤Ÿå¯é çš„æ›´æ–° Context

æ–°çš„ Context API æ”¹è¿›äº†è¿™ä¸€ç‚¹ï¼šå³ä¾¿ç»„ä»¶çš„ shouldComponentUpdate è¿”å› falseï¼Œå®ƒä»ç„¶å¯ä»¥â€œç©¿é€â€ç»„ä»¶ç»§ç»­å‘åä»£ç»„ä»¶è¿›è¡Œä¼ æ’­ï¼Œè¿›è€Œç¡®ä¿äº†æ•°æ®ç”Ÿäº§è€…å’Œæ•°æ®æ¶ˆè´¹è€…ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ã€‚å†åŠ ä¸Šæ›´åŠ â€œå¥½çœ‹â€çš„è¯­ä¹‰åŒ–çš„å£°æ˜å¼å†™æ³•ï¼Œæ–°ç‰ˆ Context API ç»ˆäºé¡ºåˆ©åœ°æ‘˜æ‰äº†â€œè¯•éªŒæ€§ APIâ€çš„å¸½å­ï¼Œæˆäº†ä¸€ç§ç¡®å®å¯è¡Œçš„ React ç»„ä»¶é—´é€šä¿¡è§£å†³æ–¹æ¡ˆ
:::

### å…¨å±€å˜é‡ä¸äº‹ä»¶

å…¨å±€å˜é‡ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ”¾åœ¨ Window ä¸Šçš„å˜é‡ã€‚ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ä¿®æ”¹ Window ä¸Šçš„å˜é‡å¹¶ä¸ä¼šå¼•èµ· React ç»„ä»¶é‡æ–°æ¸²æŸ“

æ‰€ä»¥åœ¨ä½¿ç”¨åœºæ™¯ä¸Šï¼Œå…¨å±€å˜é‡æ›´æ¨èç”¨äºæš‚å­˜ä¸´æ—¶æ•°æ®ã€‚æ¯”å¦‚åœ¨ CallPage é¡µé¢ç‚¹å‡»äº†æŒ‰é’®ä¹‹åï¼Œéœ€è¦æ”¶é›†ä¸€ä¸ª callIdï¼Œç„¶ååœ¨ ReportPage ä¸ŠæŠ¥è¿™ä¸ª callId

```js
class CallPage extends React.Component {
    render() {
        return <Button onClick={() => {
              window.callId = this.props.callId
        }} />
}
class ReportPage extends React.Component {

    render() {
        return <Button onClick={() => {
              fetch('/api/report', { id: window.callId })
        }} />
    }
}
```

å¦‚æœåœ¨è¿™é‡Œä½¿ç”¨ Contextï¼Œä¼šæ˜¾å¾—æœ‰ç‚¹é‡ï¼Œä½†æ˜¯åªä¾é  Window åšå€¼çš„æš‚å­˜å°±ä¼šç®€å•å¾ˆå¤šã€‚é‚£ä¸ºä»€ä¹ˆä¸å¤ªæ¨èè¿™ä¸ªæ–¹æ¡ˆå‘¢ï¼Ÿå› ä¸ºå®ƒè·³å‡ºäº†è®¾è®¡æ¨¡å¼ï¼Œç”¨å·æ‡’æ¢å–äº†å¿«æ·ï¼Œåœ¨åç»­çš„ç»´æŠ¤ä¸­ï¼Œå¦‚æœä¸šåŠ¡éœ€æ±‚å‘ç”Ÿå˜æ›´ï¼Œæ¯”å¦‚éœ€è¦åœ¨æŸå¤„æ˜¾ç¤º callIdï¼Œåœ¨ callId å˜åŒ–åï¼Œå°±è¦é‡æ–°æ¸²æŸ“æ–°çš„ callIdã€‚é‚£ä¹ˆ Window çš„åŠ£åŠ¿å°±æš´éœ²æ— é—äº†

**é™¤äº†å…¨å±€å˜é‡ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯å…¨å±€äº‹ä»¶**

```js
class CallPage extends React.Component {
    dispatchEvent = () => {
        document.dispatchEvent(new CustomEvent('callEvent', {
          detail: {
             callId: this.props.callId
          }
        }))
    }
    render() {
        return <Button onClick={this.dispatchEvent} />
}
class ReportPage extends React.Component {
    state = {
      callId: null,
    }

    changeCallId = (e) => {
      this.setState({
        callId: e.detail.callId
      })
    }

    componentDidMount() {
        document.addEventListener('callEvent', this.changeCallId)
    }
    componentWillUnmount() {
        document.removeEventListener('callEvent', this.changeCallId)
    }

    render() {
        return <Button onClick={() => {
              fetch('/api/report', { id: this.state.callId })
        }} />
    }
}
```

ç²—çœ‹ä»£ç ï¼Œäº‹ä»¶çš„æ–¹å¼è®©æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ state çš„å€¼ï¼Œæ‰€ä»¥å¯ä»¥é‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚ä½†ä¸è¦å¿˜è®°ï¼Œäº‹ä»¶çš„ç»‘å®šå¾€å¾€ä¼šåœ¨ç»„ä»¶åŠ è½½æ—¶æ”¾å…¥ï¼Œå¦‚æœ CallPage ä¸ ReportPage ä¸æ˜¯åŒæ—¶å­˜åœ¨äºé¡µé¢ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ¡ˆåˆä¸é€‚ç”¨äº†

## çŠ¶æ€ç®¡ç†æ¡†æ¶

çŠ¶æ€ç®¡ç†æ¡†æ¶æä¾›äº†éå¸¸ä¸°å¯Œçš„è§£å†³æ–¹æ¡ˆï¼Œå¸¸è§çš„æœ‰ Fluxã€Redux åŠ Mobxï¼Œç”šè‡³åœ¨ä¸€å®šç¨‹åº¦ä¸Šçº¦æŸäº†é¡¹ç›®çš„ä»£ç ç»“æ„ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹çš„çŠ¶æ€ç®¡ç†æ¡†æ¶ä¸»è¦å›°éš¾ç‚¹åœ¨äºå­¦ä¹ æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œä¸”æ•´ä¸ªå·¥ç¨‹çš„å¼€å‘æ€è·¯ä¹Ÿå°†éšç€æ¡†æ¶çš„å¼•å…¥è€Œæ”¹å˜

è¿™ä¸€éƒ¨åˆ†ä¸»è¦è®²è®² redux

### ä»€ä¹ˆæ˜¯ Redux

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®˜æ–¹å¯¹ Redux çš„æè¿°ï¼š

> Redux æ˜¯ JavaScript çŠ¶æ€å®¹å™¨ï¼Œå®ƒæä¾›å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†ã€‚

æˆ‘ä»¬ä¸€èµ·å“å“è¿™å¥è¯èƒŒåçš„æ·±æ„ï¼š

1. Redux æ˜¯ä¸º JavaScript åº”ç”¨è€Œç”Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸æ˜¯ React çš„ä¸“åˆ©ï¼ŒReact å¯ä»¥ç”¨ï¼ŒVue å¯ä»¥ç”¨ï¼ŒåŸç”Ÿ JavaScript ä¹Ÿå¯ä»¥ç”¨ï¼›

2. Redux æ˜¯ä¸€ä¸ªçŠ¶æ€å®¹å™¨

![](https://s0.lgstatic.com/i/image/M00/62/97/CgqCHl-Sm9qASdHXAAEjhh30y4s113.png)

### Redux æ˜¯å¦‚ä½•å¸®åŠ© React ç®¡ç†æ•°æ®çš„

Redux ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šstoreã€reducer å’Œ actionã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒä»¬å„è‡ªä»£è¡¨ä»€ä¹ˆï¼š

1. store å°±å¥½æ¯”ç»„ä»¶ç¾¤é‡Œçš„â€œç¾¤æ–‡ä»¶â€ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¸€çš„æ•°æ®æºï¼Œè€Œä¸”æ˜¯åªè¯»çš„ï¼›
2. action äººå¦‚å…¶åï¼Œæ˜¯â€œåŠ¨ä½œâ€çš„æ„æ€ï¼Œå®ƒæ˜¯å¯¹å˜åŒ–çš„æè¿°
3. reducer æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè´Ÿè´£å¯¹å˜åŒ–è¿›è¡Œåˆ†å‘å’Œå¤„ç†ï¼Œ æœ€ç»ˆå°†æ–°çš„æ•°æ®è¿”å›ç»™ store

![](https://s0.lgstatic.com/i/image/M00/62/97/CgqCHl-Sm-yADE6PAACSEywFSaA197.png)

ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè¯»å‡ºçš„æ˜¯æ•°æ®çš„æµå‘è§„å¾‹ï¼šåœ¨ Redux çš„æ•´ä¸ªå·¥ä½œè¿‡ç¨‹ä¸­ï¼Œæ•°æ®æµæ˜¯ä¸¥æ ¼å•å‘çš„

å¯¹äºä¸€ä¸ª React åº”ç”¨æ¥è¯´ï¼Œè§†å›¾ï¼ˆViewï¼‰å±‚é¢çš„æ‰€æœ‰æ•°æ®ï¼ˆstateï¼‰éƒ½æ¥è‡ª storeï¼ˆå†ä¸€æ¬¡è¯ é‡Šäº†å•ä¸€æ•°æ®æºçš„åŸåˆ™ï¼‰,å¦‚æœä½ æƒ³å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œåªæœ‰ä¸€ç§é€”å¾„ï¼šæ´¾å‘ actionã€‚action ä¼šè¢« reducer è¯»å–ï¼Œè¿›è€Œæ ¹æ® action å†…å®¹çš„ä¸åŒå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€ç”Ÿæˆæ–°çš„ stateï¼ˆçŠ¶æ€ï¼‰ï¼Œè¿™ä¸ªæ–°çš„ state ä¼šæ›´æ–°åˆ° store å¯¹è±¡é‡Œï¼Œè¿›è€Œé©±åŠ¨è§†å›¾å±‚é¢åšå‡ºå¯¹åº”çš„æ”¹å˜

å¯¹äºç»„ä»¶æ¥è¯´ï¼Œä»»ä½•ç»„ä»¶éƒ½å¯ä»¥é€šè¿‡çº¦å®šçš„æ–¹å¼ä» store è¯»å–åˆ°å…¨å±€çš„çŠ¶æ€ï¼Œä»»ä½•ç»„ä»¶ä¹Ÿéƒ½å¯ä»¥é€šè¿‡åˆç†åœ°æ´¾å‘ action æ¥ä¿®æ”¹å…¨å±€çš„çŠ¶æ€ã€‚Redux é€šè¿‡æä¾›ä¸€ä¸ªç»Ÿä¸€çš„çŠ¶æ€å®¹å™¨ï¼Œä½¿å¾—æ•°æ®èƒ½å¤Ÿè‡ªç”±è€Œæœ‰åºåœ°åœ¨ä»»æ„ç»„ä»¶ä¹‹é—´ç©¿æ¢­ï¼Œè¿™å°±æ˜¯ Redux å®ç°ç»„ä»¶é—´é€šä¿¡çš„æ€è·¯

### ä½¿ç”¨ Redux

1. ä½¿ç”¨ createStore æ¥å®Œæˆ store å¯¹è±¡çš„åˆ›å»º

```js
// å¼•å…¥ redux
import { createStore } from 'redux'
// åˆ›å»º store
const store = createStore(
    reducer,
    initial_state,
    applyMiddleware(middleware1, middleware2, ...)
);
```

createStore æ–¹æ³•æ˜¯ä¸€åˆ‡çš„å¼€å§‹ï¼Œå®ƒæ¥æ”¶ä¸‰ä¸ªå…¥å‚ï¼š

- reducerï¼›
- åˆå§‹çŠ¶æ€å†…å®¹ï¼›
- æŒ‡å®šä¸­é—´ä»¶ï¼ˆè¿™ä¸ªä½ å…ˆä¸ç”¨ç®¡ï¼‰ã€‚

è¿™å…¶ä¸­ä¸€èˆ¬æ¥è¯´ï¼Œåªæœ‰ reducer æ˜¯ä½ ä¸å¾—ä¸ä¼ çš„

2. reducer çš„ä½œç”¨æ˜¯å°†æ–°çš„ state è¿”å›ç»™ store

ä¸€ä¸ª reducer ä¸€å®šæ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œå®ƒå¯ä»¥æœ‰å„ç§å„æ ·çš„å†…åœ¨é€»è¾‘ï¼Œä½†å®ƒæœ€ç»ˆä¸€å®šè¦è¿”å›ä¸€ä¸ª state

```js
const reducer = (state, action) => {
  // æ­¤å¤„æ˜¯å„ç§æ ·çš„ stateå¤„ç†é€»è¾‘
  return new_state;
};
```

å½“æˆ‘ä»¬åŸºäºæŸä¸ª reducer å»åˆ›å»º store çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯ç»™è¿™ä¸ª store æŒ‡å®šäº†ä¸€å¥—æ›´æ–°è§„åˆ™

```js
// æ›´æ–°è§„åˆ™å…¨éƒ½å†™åœ¨ reducer é‡Œ
const store = createStore(reducer);
```

3. action çš„ä½œç”¨æ˜¯é€šçŸ¥ reducer â€œè®©æ”¹å˜å‘ç”Ÿâ€

å¦‚ä½•åœ¨æµ©å¦‚çƒŸæµ·çš„ store çŠ¶æ€åº“ä¸­ï¼Œå‡†ç¡®åœ°å‘½ä¸­æŸä¸ªæˆ‘ä»¬å¸Œæœ›å®ƒå‘ç”Ÿæ”¹å˜çš„ state å‘¢ï¼Ÿreducer å†…éƒ¨çš„é€»è¾‘è™½ç„¶ä¸å°½ç›¸åŒï¼Œä½†å…¶æœ¬è´¨å·¥ä½œéƒ½æ˜¯â€œå°† action ä¸å’Œå®ƒå¯¹åº”çš„æ›´æ–°åŠ¨ä½œå¯¹åº”èµ·æ¥ï¼Œå¹¶å¤„ç†è¿™ä¸ªæ›´æ–°â€ã€‚æ‰€ä»¥è¯´è¦æƒ³è®© state å‘ç”Ÿæ”¹å˜ï¼Œå°±å¿…é¡»ç”¨æ­£ç¡®çš„ action æ¥é©±åŠ¨è¿™ä¸ªæ”¹å˜

```js
const action = {
  type: "ADD_ITEM",
  payload: "<li>text</li>",
};
```

action å¯¹è±¡ä¸­å…è®¸ä¼ å…¥çš„å±æ€§æœ‰å¤šä¸ªï¼Œä½†åªæœ‰ type æ˜¯å¿…ä¼ çš„ã€‚type æ˜¯ action çš„å”¯ä¸€æ ‡è¯†ï¼Œreducer æ­£æ˜¯é€šè¿‡ä¸åŒçš„ type æ¥è¯†åˆ«å‡ºéœ€è¦æ›´æ–°çš„ä¸åŒçš„ stateï¼Œç”±æ­¤æ‰èƒ½å¤Ÿå®ç°ç²¾å‡†çš„â€œå®šå‘æ›´æ–°â€

4. æ´¾å‘ actionï¼Œé çš„æ˜¯ dispatch

action æœ¬èº«åªæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¦æƒ³è®© reducer æ„ŸçŸ¥åˆ° actionï¼Œè¿˜éœ€è¦â€œæ´¾å‘ actionâ€è¿™ä¸ªåŠ¨ä½œï¼Œè¿™ä¸ªåŠ¨ä½œæ˜¯ç”± store.dispatch å®Œæˆçš„

```js
store.dispatch(action);
```

::: tip å¤§è‡´æ˜¯è¿™ä¹ˆä¸ªæµç¨‹

![](https://s0.lgstatic.com/i/image/M00/81/9F/CgqCHl_Rii2AVvUbAADn4s_6rB8369.png)

```js
import { createStore } from "redux";
// åˆ›å»º reducer
const reducer = (state, action) => {
  // æ­¤å¤„æ˜¯å„ç§æ ·çš„ stateå¤„ç†é€»è¾‘
  return new_state;
};
// åŸºäº reducer åˆ›å»º state
const store = createStore(reducer);
// åˆ›å»ºä¸€ä¸ª actionï¼Œè¿™ä¸ª action ç”¨ â€œADD_ITEMâ€ æ¥æ ‡è¯†
const action = {
  type: "ADD_ITEM",
  payload: "<li>text</li>",
};
// ä½¿ç”¨ dispatch æ´¾å‘ actionï¼Œaction ä¼šè¿›å…¥åˆ° reducer é‡Œè§¦å‘å¯¹åº”çš„æ›´æ–°
```
:::
